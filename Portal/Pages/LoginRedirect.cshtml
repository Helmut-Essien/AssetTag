@page
@model Portal.Pages.LoginRedirectModel
@{
    Layout = "_AuthLayout";
    ViewData["Title"] = "Initializing Session";
}

@section Styles {
    <link rel="stylesheet" href="~/css/loginRedirect.css" asp-append-version="true" />
}

<!-- Meta refresh for reliable redirect -->
<meta http-equiv="refresh" content="3;url=@Model.ReturnUrl" />

<!-- Logo -->
<img src="~/Resources/mlogo.jpeg" alt="Methodist University Ghana Logo" class="logo-img" />
<h2 class="h5 fw-bold mb-2 text-center">Initializing Session</h2>
<p class="text-muted mb-4 text-center">Preparing your dashboard securely</p>
<p class="values text-center">Excellence • Morality • Service</p>

<!-- Main content -->
<div class="redirect-loader">
    <!-- Minimal spinner -->
    <div class="spinner"></div>

    <!-- Countdown -->
    <div class="countdown-display">
        <div class="countdown-number" id="countdown">3</div>
        <p class="text-muted small">seconds remaining</p>
    </div>

    <!-- Status messages -->
    <div class="status-messages">
        <p><i class="bi bi-shield-check"></i> Verifying authentication...</p>
        <p><i class="bi bi-person-check"></i> Loading profile...</p>
        <p><i class="bi bi-gear"></i> Preparing interface...</p>
    </div>

    <!-- Info message -->
    <div class="alert">
        <i class="bi bi-info-circle"></i>
        You will be redirected automatically
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set session flags
            sessionStorage.setItem('justLoggedIn', 'true');
            sessionStorage.setItem('loginTime', Date.now());

            // Visual countdown
            let seconds = 3;
            const countdownEl = document.getElementById('countdown');
            const interval = setInterval(() => {
                seconds--;

                if (seconds <= 0) {
                    clearInterval(interval);

                    // Show success state
                    document.querySelector('.redirect-loader').classList.add('success-animation');
                    countdownEl.textContent = "✓";

                    // Update message
                    const alertEl = document.querySelector('.alert');
                    alertEl.innerHTML = '<i class="bi bi-check-circle"></i> Ready! Redirecting...';

                } else {
                    countdownEl.textContent = seconds;
                }
            }, 1000);

            // Safety fallback
            setTimeout(() => {
                if (window.location.pathname.includes('/LoginRedirect')) {
                    window.location.href = '@Model.ReturnUrl';
                }
            }, 5000);
        });
    </script>
}