

@page
@model Portal.Pages.Account.RegisterModel
@{
    Layout = "_AuthLayout";
    ViewData["Title"] = "Create Account";
}

<!-- Logo -->
<img src="~/Resources/mlogo.jpeg" alt="Methodist University Ghana Logo" class="logo-img mb-4" />
<h1 class="h4 fw-bold">Create Account</h1>
<p class="text-muted">Join Methodist University Ghana Asset Portal</p>
<p class="values">Excellence • Morality • Service</p>

<!-- Token Error Message -->
@if (!string.IsNullOrEmpty(Model.TokenErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.TokenErrorMessage
        <div class="mt-2">
            <a asp-page="/Account/Login" class="btn btn-primary btn-sm">Back to Login</a>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Success Message -->
@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Model.SuccessMessage
        <div class="mt-2">
            <a asp-page="/Account/Login" class="btn btn-success btn-sm">Login Now</a>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Error Message -->
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Registration Form (Multi-step Wizard) - Only show if token is valid -->
@if (Model.IsValidToken && !Model.IsSuccess)
{ 
    <form method="post" id="registerForm" asp-antiforgery="true" novalidate>
        <input type="hidden" asp-for="Input.Token" />
        <input type="hidden" asp-for="Input.Email" />

        <!-- Step 1: Personal Information -->
        <div class="step" id="step1">
            <div class="step-indicator mb-4">
                <div class="d-flex justify-content-center">
                    <span class="step-dot active" data-step="1"></span>
                    <span class="step-dot" data-step="2"></span>
                    <span class="step-dot" data-step="3"></span>
                </div>
                <div class="step-text text-center mt-2">Personal Information</div>
            </div>

            <div class="invitation-info alert alert-info mb-4">
                <small>
                    <strong>Invitation Details:</strong><br />
                    Email: <strong>@Model.Input.Email</strong><br />
                    @if (!string.IsNullOrEmpty(Model.InvitationRole))
                    {
                        <text>Role: <strong>@Model.InvitationRole</strong></text>
                    }
                </small>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="Input.FirstName" class="form-label">First Name *</label>
                        <input asp-for="Input.FirstName" class="form-control form-control-lg" placeholder="First Name" required />
                        <span asp-validation-for="Input.FirstName" class="text-danger small validation-error"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="Input.Surname" class="form-label">Surname *</label>
                        <input asp-for="Input.Surname" class="form-control form-control-lg" placeholder="Surname" required />
                        <span asp-validation-for="Input.Surname" class="text-danger small validation-error"></span>
                    </div>
                </div>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Input.OtherNames" class="form-label">Other Names</label>
                <input asp-for="Input.OtherNames" class="form-control form-control-lg" placeholder="Other Names (Optional)" />
                <span asp-validation-for="Input.OtherNames" class="text-danger small validation-error"></span>
            </div>

            <div class="d-grid">
                <button type="button" class="btn btn-primary btn-lg button" onclick="validateStep(1)">Next</button>
            </div>
        </div>

        <!-- Step 2: Account Details -->
        <div class="step" id="step2" style="display: none;">
            <div class="step-indicator mb-4">
                <div class="d-flex justify-content-center">
                    <span class="step-dot completed" data-step="1"></span>
                    <span class="step-dot active" data-step="2"></span>
                    <span class="step-dot" data-step="3"></span>
                </div>
                <div class="step-text text-center mt-2">Account Details</div>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Input.Username" class="form-label">Username *</label>
                <input asp-for="Input.Username" class="form-control form-control-lg" placeholder="Username"
                       pattern="^[a-zA-Z0-9_]+$" minlength="3" maxlength="50" required />
                <div class="form-text">3-50 characters, letters, numbers, and underscores only</div>
                <span asp-validation-for="Input.Username" class="text-danger small validation-error"></span>
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control form-control-lg" value="@Model.Input.Email" readonly disabled />
                <div class="form-text">Your email is set by your invitation and cannot be changed</div>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Input.JobRole" class="form-label">Job Role</label>
                <input asp-for="Input.JobRole" class="form-control form-control-lg" placeholder="Your job role (Optional)" />
                <span asp-validation-for="Input.JobRole" class="text-danger small validation-error"></span>
            </div>

            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary btn-lg" onclick="prevStep(2)">Back</button>
                <button type="button" class="btn btn-primary btn-lg button" onclick="validateStep(2)">Next</button>
            </div>
        </div>

        <!-- Step 3: Security -->
        <div class="step" id="step3" style="display: none;">
            <div class="step-indicator mb-4">
                <div class="d-flex justify-content-center">
                    <span class="step-dot completed" data-step="1"></span>
                    <span class="step-dot completed" data-step="2"></span>
                    <span class="step-dot active" data-step="3"></span>
                </div>
                <div class="step-text text-center mt-2">Security</div>
            </div>

            <div class="form-group mb-3 position-relative">
                <label asp-for="Input.Password" class="form-label">Password *</label>
                <input asp-for="Input.Password" type="password" class="form-control form-control-lg"
                       placeholder="Password" minlength="6" required id="passwordInput" />
                <div class="form-text">At least 6 characters</div>
                <span asp-validation-for="Input.Password" class="text-danger small validation-error"></span>
            <span class="password-toggleR" onclick="togglePassword('passwordInput', 'passwordToggle')" id="passwordToggle">🙈</span>
            </div>

            <div class="form-group mb-4 position-relative">
                <label asp-for="Input.ConfirmPassword" class="form-label">Confirm Password *</label>
                <input asp-for="Input.ConfirmPassword" type="password" class="form-control form-control-lg"
                       placeholder="Confirm Password" required id="confirmPasswordInput" />
                <span asp-validation-for="Input.ConfirmPassword" class="text-danger small validation-error"></span>
            <span class="password-toggleR" onclick="togglePassword('confirmPasswordInput', 'confirmPasswordToggle')" id="confirmPasswordToggle">🙈</span>
            </div>

            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary btn-lg" onclick="prevStep(3)">Back</button>
                <button type="submit" class="btn btn-success btn-lg button" id="registerButton" aria-live="polite">
                    <span class="button__text">Create Account</span>
                    <div class="button__spinner" style="display: none;">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="ms-2">Creating Account...</span>
                    </div>
                </button>
            </div>
        </div>
    </form>
}

<!-- Login Link -->
@if (Model.IsValidToken)
{
    <div class="text-center mt-4">
        <p class="text-muted">
            Already have an account?
            <a asp-page="/Account/Login" class="text-primary text-decoration-none">Sign in</a>
        </p>
    </div>
}

@section Scripts {
    <script>
        // Password visibility toggle
        function togglePassword(inputId, toggleId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.getElementById(toggleId);
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.textContent = '👁️';
            } else {
                passwordInput.type = 'password';
                toggleIcon.textContent = '🙈';
            }
        }

        // Enhanced multi-step form logic with validation
        let currentStep = 1;

        function showStep(step) {
            currentStep = step;
            document.querySelectorAll('.step').forEach(function(el) {
                el.style.display = 'none';
            });
            document.getElementById('step' + step).style.display = 'block';

            // Update step indicators for the current step
            updateStepIndicators(step);
        }

        function updateStepIndicators(activeStep) {
            // Get all step dots in the current visible step
            const currentStepElement = document.getElementById('step' + activeStep);
            if (!currentStepElement) return;

            const stepDots = currentStepElement.querySelectorAll('.step-dot');

            stepDots.forEach((dot, index) => {
                const dotStep = parseInt(dot.getAttribute('data-step'));
                dot.classList.remove('active', 'completed');

                if (dotStep === activeStep) {
                    dot.classList.add('active');
                } else if (dotStep < activeStep) {
                    dot.classList.add('completed');
                }
            });
        }

        function validateStep(step) {
            const stepElement = document.getElementById('step' + step);
            const inputs = stepElement.querySelectorAll('input[required]');
            let isValid = true;
            let firstInvalidInput = null;

            // Clear previous validation errors
            stepElement.querySelectorAll('.validation-error').forEach(error => {
                error.textContent = '';
            });

            // Validate each input
            inputs.forEach(input => {
                input.classList.remove('is-invalid');

                if (!input.checkValidity()) {
                    isValid = false;
                    input.classList.add('is-invalid');

                    // Show validation message
                    const errorElement = input.parentElement.querySelector('.validation-error');
                    if (errorElement) {
                        if (input.validity.valueMissing) {
                            errorElement.textContent = 'This field is required.';
                        } else if (input.validity.typeMismatch) {
                            errorElement.textContent = 'Please enter a valid email address.';
                        } else if (input.validity.patternMismatch) {
                            if (input.id.includes('Username')) {
                                errorElement.textContent = 'Username can only contain letters, numbers, and underscores.';
                            }
                        } else if (input.validity.tooShort) {
                            errorElement.textContent = `Minimum length is ${input.minLength} characters.`;
                        } else if (input.validity.tooLong) {
                            errorElement.textContent = `Maximum length is ${input.maxLength} characters.`;
                        }
                    }

                    if (!firstInvalidInput) {
                        firstInvalidInput = input;
                    }
                }
            });

            // Special validation for password confirmation in step 3
            if (step === 3) {
                const passwordInput = document.getElementById('passwordInput');
                const confirmPasswordInput = document.getElementById('confirmPasswordInput');
                const confirmErrorElement = confirmPasswordInput.parentElement.querySelector('.validation-error');

                if (passwordInput.value !== confirmPasswordInput.value) {
                    isValid = false;
                    confirmPasswordInput.classList.add('is-invalid');
                    if (confirmErrorElement) {
                        confirmErrorElement.textContent = 'Passwords do not match.';
                    }
                    if (!firstInvalidInput) {
                        firstInvalidInput = confirmPasswordInput;
                    }
                }
            }

            if (!isValid && firstInvalidInput) {
                firstInvalidInput.focus();
                return false;
            }

            // If all valid, proceed to next step
            if (step < 3) {
                showStep(step + 1);
            }
            return true;
        }

        function prevStep(currentStep) {
            showStep(currentStep - 1);
        }

        // Initialize first step
        showStep(1);

        // Form submission handler
        (function () {
            const form = document.getElementById('registerForm');
            const btn = document.getElementById('registerButton');
            const buttonText = btn?.querySelector('.button__text');
            const buttonSpinner = btn?.querySelector('.button__spinner');

            if (!form || !btn) return;

            form.addEventListener('submit', function (e) {
                // Validate all steps before submission
                let allStepsValid = true;

                for (let step = 1; step <= 3; step++) {
                    if (!validateStep(step)) {
                        allStepsValid = false;
                        showStep(step); // Show the first invalid step
                        break;
                    }
                }

                if (!allStepsValid) {
                    e.preventDefault();
                    return;
                }

                // Add loading state
                if (buttonText && buttonSpinner) {
                    buttonText.style.display = 'none';
                    buttonSpinner.style.display = 'flex';
                }
                btn.disabled = true;
            });
        })();

        // Real-time validation for password match
        (function () {
            const passwordInput = document.getElementById('passwordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');

            function validatePasswordMatch() {
                if (passwordInput && confirmPasswordInput && passwordInput.value !== confirmPasswordInput.value) {
                    confirmPasswordInput.setCustomValidity('Passwords do not match');
                } else if (confirmPasswordInput) {
                    confirmPasswordInput.setCustomValidity('');
                }
            }

            if (passwordInput && confirmPasswordInput) {
                passwordInput.addEventListener('input', validatePasswordMatch);
                confirmPasswordInput.addEventListener('input', validatePasswordMatch);
            }
        })();
    </script>

    <style>
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dee2e6;
            margin: 0 8px;
            transition: all 0.3s ease;
            display: inline-block;
            position: relative;
        }

            .step-dot.active {
                background-color: #0d6efd;
                transform: scale(1.3);
                box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
            }

            .step-dot.completed {
                background-color: #198754;
            }

        .step-text {
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
        }

        .button--loading .button__text {
            visibility: hidden;
            opacity: 0;
        }

        .button--loading .button__spinner {
            visibility: visible;
            opacity: 1;
        }

        .password-toggleR {
            position: absolute;
            right: 12px;
            top: 48px;
            cursor: pointer;
            user-select: none;
            z-index: 10;
        }

        .is-invalid {
            border-color: #dc3545 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        .validation-error {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875em;
        }

        .form-text {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .invitation-info {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
        }
    </style>

    <partial name="_ValidationScriptsPartial" />
}

@* <!-- Logo -->
<img src="~/Resources/mlogo.jpeg" alt="Methodist University Ghana Logo" class="logo-img mb-4" />
<h1 class="h4 fw-bold">Create Account</h1>
<p class="text-muted">Join Methodist University Ghana Asset Portal</p>
<p class="values">Excellence • Morality • Service</p>

<!-- Success Message -->
@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Error Message -->
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Registration Form (Multi-step Wizard) -->
<form method="post" id="registerForm" asp-antiforgery="true" novalidate>
    <!-- Step 1: First Name and Surname -->
    <div class="step" id="step1">
        <div class="step-indicator mb-4">
            <div class="d-flex justify-content-center">
                <span class="step-dot active" data-step="1"></span>
                <span class="step-dot" data-step="2"></span>
                <span class="step-dot" data-step="3"></span>
            </div>
            <div class="step-text text-center mt-2">Personal Information</div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label asp-for="Input.FirstName" class="form-label">First Name *</label>
                    <input asp-for="Input.FirstName" class="form-control form-control-lg" placeholder="First Name" required />
                    <span asp-validation-for="Input.FirstName" class="text-danger small validation-error"></span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label asp-for="Input.Surname" class="form-label">Surname *</label>
                    <input asp-for="Input.Surname" class="form-control form-control-lg" placeholder="Surname" required />
                    <span asp-validation-for="Input.Surname" class="text-danger small validation-error"></span>
                </div>
            </div>
        </div>
        <div class="d-grid">
            <button type="button" class="btn btn-primary btn-lg button" onclick="validateStep(1)">Next</button>
        </div>
    </div>

    <!-- Step 2: Username and Email -->
    <div class="step" id="step2" style="display: none;">
        <div class="step-indicator mb-4">
            <div class="d-flex justify-content-center">
                <span class="step-dot completed" data-step="1"></span>
                <span class="step-dot active" data-step="2"></span>
                <span class="step-dot" data-step="3"></span>
            </div>
            <div class="step-text text-center mt-2">Account Details</div>
        </div>

        <div class="form-group mb-3">
            <label asp-for="Input.Username" class="form-label">Username *</label>
            <input asp-for="Input.Username" class="form-control form-control-lg" placeholder="Username"
                   pattern="^[a-zA-Z0-9_]+$" minlength="3" maxlength="50" required />
            <div class="form-text">3-50 characters, letters, numbers, and underscores only</div>
            <span asp-validation-for="Input.Username" class="text-danger small validation-error"></span>
        </div>
        <div class="form-group mb-3">
            <label asp-for="Input.Email" class="form-label">Email *</label>
            <input asp-for="Input.Email" type="email" class="form-control form-control-lg" placeholder="Email" required />
            <span asp-validation-for="Input.Email" class="text-danger small validation-error"></span>
        </div>
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary btn-lg" onclick="prevStep(2)">Back</button>
            <button type="button" class="btn btn-primary btn-lg button" onclick="validateStep(2)">Next</button>
        </div>
    </div>

    <!-- Step 3: Password and Confirm Password -->
    <div class="step" id="step3" style="display: none;">
        <div class="step-indicator mb-4">
            <div class="d-flex justify-content-center">
                <span class="step-dot completed" data-step="1"></span>
                <span class="step-dot completed" data-step="2"></span>
                <span class="step-dot active" data-step="3"></span>
            </div>
            <div class="step-text text-center mt-2">Security</div>
        </div>

        <div class="form-group mb-3 position-relative">
            <label asp-for="Input.Password" class="form-label">Password *</label>
            <input asp-for="Input.Password" type="password" class="form-control form-control-lg"
                   placeholder="Password" minlength="6" required id="passwordInput" />
            <div class="form-text">At least 6 characters</div>
            <span asp-validation-for="Input.Password" class="text-danger small validation-error"></span>
            <span class="password-toggle" onclick="togglePassword('passwordInput', 'passwordToggle')" id="passwordToggle">👁️</span>
        </div>
        <div class="form-group mb-4 position-relative">
            <label asp-for="Input.ConfirmPassword" class="form-label">Confirm Password *</label>
            <input asp-for="Input.ConfirmPassword" type="password" class="form-control form-control-lg"
                   placeholder="Confirm Password" required id="confirmPasswordInput" />
            <span asp-validation-for="Input.ConfirmPassword" class="text-danger small validation-error"></span>
            <span class="password-toggle" onclick="togglePassword('confirmPasswordInput', 'confirmPasswordToggle')" id="confirmPasswordToggle">👁️</span>
        </div>
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary btn-lg" onclick="prevStep(3)">Back</button>
            <button type="submit" class="btn btn-success btn-lg button" id="registerButton" aria-live="polite">
                <span class="button__text">Create Account</span>
                <div class="button__spinner" style="display: none;">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span class="ms-2">Creating Account...</span>
                </div>
            </button>
        </div>
    </div>
</form>

<!-- Login Link -->
<div class="text-center mt-4">
    <p class="text-muted">
        Already have an account?
        <a asp-page="/Account/Login" class="text-primary text-decoration-none">Sign in</a>
    </p>
</div>

@section Scripts {
    <script>
        // Password visibility toggle
        function togglePassword(inputId, toggleId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.getElementById(toggleId);
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                toggleIcon.textContent = '👁️';
            }
        }

        // Enhanced multi-step form logic with validation
        let currentStep = 1;

        function showStep(step) {
            currentStep = step;
            document.querySelectorAll('.step').forEach(function(el) {
                el.style.display = 'none';
            });
            document.getElementById('step' + step).style.display = 'block';

            // Update step indicators for the current step
            updateStepIndicators(step);
        }

        function updateStepIndicators(activeStep) {
            // Get all step dots in the current visible step
            const currentStepElement = document.getElementById('step' + activeStep);
            if (!currentStepElement) return;

            const stepDots = currentStepElement.querySelectorAll('.step-dot');

            stepDots.forEach((dot, index) => {
                const dotStep = parseInt(dot.getAttribute('data-step'));
                dot.classList.remove('active', 'completed');

                if (dotStep === activeStep) {
                    dot.classList.add('active');
                } else if (dotStep < activeStep) {
                    dot.classList.add('completed');
                }
            });
        }

        function validateStep(step) {
            const stepElement = document.getElementById('step' + step);
            const inputs = stepElement.querySelectorAll('input[required]');
            let isValid = true;
            let firstInvalidInput = null;

            // Clear previous validation errors
            stepElement.querySelectorAll('.validation-error').forEach(error => {
                error.textContent = '';
            });

            // Validate each input
            inputs.forEach(input => {
                input.classList.remove('is-invalid');

                if (!input.checkValidity()) {
                    isValid = false;
                    input.classList.add('is-invalid');

                    // Show validation message
                    const errorElement = input.parentElement.querySelector('.validation-error');
                    if (errorElement) {
                        if (input.validity.valueMissing) {
                            errorElement.textContent = 'This field is required.';
                        } else if (input.validity.typeMismatch) {
                            errorElement.textContent = 'Please enter a valid email address.';
                        } else if (input.validity.patternMismatch) {
                            if (input.id.includes('Username')) {
                                errorElement.textContent = 'Username can only contain letters, numbers, and underscores.';
                            }
                        } else if (input.validity.tooShort) {
                            errorElement.textContent = `Minimum length is ${input.minLength} characters.`;
                        } else if (input.validity.tooLong) {
                            errorElement.textContent = `Maximum length is ${input.maxLength} characters.`;
                        }
                    }

                    if (!firstInvalidInput) {
                        firstInvalidInput = input;
                    }
                }
            });

            // Special validation for password confirmation in step 3
            if (step === 3) {
                const passwordInput = document.getElementById('passwordInput');
                const confirmPasswordInput = document.getElementById('confirmPasswordInput');
                const confirmErrorElement = confirmPasswordInput.parentElement.querySelector('.validation-error');

                if (passwordInput.value !== confirmPasswordInput.value) {
                    isValid = false;
                    confirmPasswordInput.classList.add('is-invalid');
                    if (confirmErrorElement) {
                        confirmErrorElement.textContent = 'Passwords do not match.';
                    }
                    if (!firstInvalidInput) {
                        firstInvalidInput = confirmPasswordInput;
                    }
                }
            }

            if (!isValid && firstInvalidInput) {
                firstInvalidInput.focus();
                return false;
            }

            // If all valid, proceed to next step
            if (step < 3) {
                showStep(step + 1);
            }
            return true;
        }

        function prevStep(currentStep) {
            showStep(currentStep - 1);
        }

        // Initialize first step
        showStep(1);

        // Form submission handler
        (function () {
            const form = document.getElementById('registerForm');
            const btn = document.getElementById('registerButton');
            const buttonText = btn.querySelector('.button__text');
            const buttonSpinner = btn.querySelector('.button__spinner');

            if (!form || !btn) return;

            form.addEventListener('submit', function (e) {
                // Validate all steps before submission
                let allStepsValid = true;

                for (let step = 1; step <= 3; step++) {
                    if (!validateStep(step)) {
                        allStepsValid = false;
                        showStep(step); // Show the first invalid step
                        break;
                    }
                }

                if (!allStepsValid) {
                    e.preventDefault();
                    return;
                }

                // Add loading state
                buttonText.style.display = 'none';
                buttonSpinner.style.display = 'flex';
                btn.disabled = true;
            });
        })();

        // Real-time validation for password match
        (function () {
            const passwordInput = document.getElementById('passwordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');

            function validatePasswordMatch() {
                if (passwordInput.value !== confirmPasswordInput.value) {
                    confirmPasswordInput.setCustomValidity('Passwords do not match');
                } else {
                    confirmPasswordInput.setCustomValidity('');
                }
            }

            if (passwordInput && confirmPasswordInput) {
                passwordInput.addEventListener('input', validatePasswordMatch);
                confirmPasswordInput.addEventListener('input', validatePasswordMatch);
            }
        })();
    </script>

    <style>
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dee2e6;
            margin: 0 8px;
            transition: all 0.3s ease;
            display: inline-block;
            position: relative;
        }

            .step-dot.active {
                background-color: #0d6efd;
                transform: scale(1.3);
                box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
            }

            .step-dot.completed {
                background-color: #198754;
            }

        .step-text {
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 38px;
            cursor: pointer;
            user-select: none;
            z-index: 10;
        }

        .button--loading .button__text {
            visibility: hidden;
            opacity: 0;
        }

        .button--loading .button__spinner {
            visibility: visible;
            opacity: 1;
        }

        .is-invalid {
            border-color: #dc3545 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        .validation-error {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875em;
        }

        .form-text {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
    </style>

    <partial name="_ValidationScriptsPartial" />
} *@