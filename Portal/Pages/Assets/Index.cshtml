@page
@model Portal.Pages.Assets.IndexModel
@{
    ViewData["Title"] = "Assets";
}

<div class="container my-4">
    <!-- Toast Container -->
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-fixed top-0 end-0 p-3">
            @if (!string.IsNullOrEmpty(Model.ToastMessage))
            {
                <div class="toast align-items-center text-white bg-@(Model.ToastType) border-0" role="alert" aria-live="assertive" aria-atomic="true" id="operationToast">
                    <div class="d-flex">
                        <div class="toast-body">
                            @Model.ToastMessage
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Assets (@Model.Assets.Count Total)</h1>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
            <i class="bi bi-plus-lg me-2"></i>Add Asset
        </button>
    </div>

    <!-- Search and Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search assets...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Retired">Retired</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                        @foreach (var category in Model.Categories)
                        {
                            <option value="@category.Name">@category.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Condition</label>
                    <select class="form-select" id="conditionFilter">
                        <option value="">All Conditions</option>
                        <option value="New">New</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-outline-secondary me-2" id="clearFilters">
                        <i class="bi bi-arrow-clockwise"></i> Clear
                    </button>
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="bi bi-funnel"></i> Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Assets Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="assetsTable">
            <thead class="table-dark">
                <tr>
                    <th>Asset Tag</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Condition</th>
                    <th>Assigned To</th>
                    <th>Location</th>
                    <th>Purchase Date</th>
                    <th>Value</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var asset in Model.Assets)
                {
                    <tr>
                        <td>
                            <span class="badge bg-secondary">@asset.AssetTag</span>
                        </td>
                        <td>@asset.Name</td>
                        <td>
                            @{
                                var category = Model.Categories.FirstOrDefault(c => c.CategoryId == asset.CategoryId);
                                @(category?.Name ?? "N/A")
                            }
                        </td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(asset.Status)">@asset.Status</span>
                        </td>
                        <td>
                            <span class="badge @GetConditionBadgeClass(asset.Condition)">@asset.Condition</span>
                        </td>
                        <td>
                            @{
                                var user = Model.Users.FirstOrDefault(u => u.Id == asset.AssignedToUserId);
                                @(user?.UserName ?? "Unassigned")
                            }
                        </td>
                        <td>
                            @{
                                var location = Model.Locations.FirstOrDefault(l => l.LocationId == asset.LocationId);
                                @(location?.Name ?? "N/A")
                            }
                        </td>
                        <td>@asset.PurchaseDate?.ToString("MM/dd/yyyy")</td>
                        <td>@asset.CurrentValue?.ToString("C")</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-primary btn-sm me-1"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editModal"
                                        data-id="@asset.AssetId"
                                        data-assettag="@asset.AssetTag"
                                        data-name="@asset.Name"
                                        data-description="@asset.Description"
                                        data-categoryid="@asset.CategoryId"
                                        data-locationid="@asset.LocationId"
                                        data-departmentid="@asset.DepartmentId"
                                        data-purchasedate="@asset.PurchaseDate?.ToString("yyyy-MM-dd")"
                                        data-purchaseprice="@asset.PurchasePrice"
                                        data-currentvalue="@asset.CurrentValue"
                                        data-status="@asset.Status"
                                        data-assignedtouserid="@asset.AssignedToUserId"
                                        data-serialnumber="@asset.SerialNumber"
                                        data-condition="@asset.Condition"
                                        data-vendorname="@asset.VendorName"
                                        data-invoicenumber="@asset.InvoiceNumber"
                                        data-quantity="@asset.Quantity"
                                        data-costperunit="@asset.CostPerUnit"
                                        data-totalcost="@asset.TotalCost"
                                        data-depreciationrate="@asset.DepreciationRate"
                                        data-accumulateddepreciation="@asset.AccumulatedDepreciation"
                                        data-netbookvalue="@asset.NetBookValue"
                                        data-usefullifeyears="@asset.UsefulLifeYears"
                                        data-warrantyexpiry="@asset.WarrantyExpiry?.ToString("yyyy-MM-dd")"
                                        data-disposaldate="@asset.DisposalDate?.ToString("yyyy-MM-dd")"
                                        data-disposalvalue="@asset.DisposalValue"
                                        data-remarks="@asset.Remarks">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-danger btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModal"
                                        data-id="@asset.AssetId"
                                        data-name="@asset.Name">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!Model.Assets.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-inboxes display-1 text-muted"></i>
            <h3 class="text-muted mt-3">No Assets Found</h3>
            <p class="text-muted">Get started by adding your first asset.</p>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
                <i class="bi bi-plus-lg me-2"></i>Add Your First Asset
            </button>
        </div>
    }
</div>
<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Create New Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="Create">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.AssetTag" class="form-label required"></label>
                                <input asp-for="CreateDto.AssetTag" class="form-control" required />
                                <span asp-validation-for="CreateDto.AssetTag" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Name" class="form-label required"></label>
                                <input asp-for="CreateDto.Name" class="form-control" required />
                                <span asp-validation-for="CreateDto.Name" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.CategoryId" class="form-label required"></label>
                                <select asp-for="CreateDto.CategoryId" class="form-select" required>
                                    <option value="">Select Category</option>
                                    @foreach (var category in Model.Categories)
                                    {
                                        <option value="@category.CategoryId">@category.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Status" class="form-label required"></label>
                                <select asp-for="CreateDto.Status" class="form-select" required>
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Retired">Retired</option>
                                </select>
                                <span asp-validation-for="CreateDto.Status" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.LocationId" class="form-label required"></label>
                                <select asp-for="CreateDto.LocationId" class="form-select" required>
                                    <option value="">Select Location</option>
                                    @foreach (var location in Model.Locations)
                                    {
                                        <option value="@location.LocationId">@location.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.LocationId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.DepartmentId" class="form-label required"></label>
                                <select asp-for="CreateDto.DepartmentId" class="form-select" required>
                                    <option value="">Select Department</option>
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department.DepartmentId">@department.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.DepartmentId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Condition" class="form-label required"></label>
                                <select asp-for="CreateDto.Condition" class="form-select" required>
                                    <option value="">Select Condition</option>
                                    <option value="New">New</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                                <span asp-validation-for="CreateDto.Condition" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.AssignedToUserId" class="form-label"></label>
                                <select asp-for="CreateDto.AssignedToUserId" class="form-select">
                                    <option value="">Unassigned</option>
                                    @foreach (var user in Model.Users)
                                    {
                                        <option value="@user.Id">@user.UserName</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.AssignedToUserId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="CreateDto.Description" class="form-label"></label>
                        <textarea asp-for="CreateDto.Description" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="CreateDto.Description" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.PurchaseDate" class="form-label"></label>
                                <input asp-for="CreateDto.PurchaseDate" type="date" class="form-control" />
                                <span asp-validation-for="CreateDto.PurchaseDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.PurchasePrice" class="form-label"></label>
                                <input asp-for="CreateDto.PurchasePrice" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.PurchasePrice" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.SerialNumber" class="form-label"></label>
                                <input asp-for="CreateDto.SerialNumber" class="form-control" />
                                <span asp-validation-for="CreateDto.SerialNumber" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Quantity" class="form-label"></label>
                                <input asp-for="CreateDto.Quantity" type="number" class="form-control" value="1" />
                                <span asp-validation-for="CreateDto.Quantity" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Create Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="Update">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>
                    <input type="hidden" asp-for="UpdateDto.AssetId" id="Edit_AssetId" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.AssetTag" class="form-label required"></label>
                                <input asp-for="UpdateDto.AssetTag" class="form-control" id="Edit_AssetTag" required />
                                <span asp-validation-for="UpdateDto.AssetTag" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Name" class="form-label required"></label>
                                <input asp-for="UpdateDto.Name" class="form-control" id="Edit_Name" required />
                                <span asp-validation-for="UpdateDto.Name" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Similar form structure as create modal but for edit -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.CategoryId" class="form-label required"></label>
                                <select asp-for="UpdateDto.CategoryId" class="form-select" id="Edit_CategoryId" required>
                                    <option value="">Select Category</option>
                                    @foreach (var category in Model.Categories)
                                    {
                                        <option value="@category.CategoryId">@category.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Status" class="form-label required"></label>
                                <select asp-for="UpdateDto.Status" class="form-select" id="Edit_Status" required>
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Retired">Retired</option>
                                </select>
                                <span asp-validation-for="UpdateDto.Status" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete asset "<span id="deleteAssetName"></span>"?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
                <form method="post" asp-page-handler="Delete">
                    <input type="hidden" name="id" id="deleteId" />
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .required::after {
            content: " *";
            color: #dc3545;
        }

        .table th {
            border-top: none;
            font-weight: 600;
        }

        .badge {
            font-size: 0.75em;
        }

        .btn-group .btn {
            padding: 0.25rem 0.5rem;
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize toasts
            var toastEl = document.getElementById('operationToast');
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }

            // Edit Modal
            var editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;

                    document.getElementById('Edit_AssetId').value = button.getAttribute('data-id');
                    document.getElementById('Edit_AssetTag').value = button.getAttribute('data-assettag');
                    document.getElementById('Edit_Name').value = button.getAttribute('data-name');
                    document.getElementById('Edit_CategoryId').value = button.getAttribute('data-categoryid');
                    document.getElementById('Edit_Status').value = button.getAttribute('data-status');
                    // Set other fields as needed...
                });
            }

            // Delete Modal
            var deleteModal = document.getElementById('deleteModal');
            if (deleteModal) {
                deleteModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var id = button.getAttribute('data-id');
                    var name = button.getAttribute('data-name');

                    document.getElementById('deleteId').value = id;
                    document.getElementById('deleteAssetName').textContent = name;
                });
            }

            // Search and Filter functionality
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const conditionFilter = document.getElementById('conditionFilter');
            const applyFilters = document.getElementById('applyFilters');
            const clearFilters = document.getElementById('clearFilters');

            function filterAssets() {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                const categoryValue = categoryFilter.value;
                const conditionValue = conditionFilter.value;

                const rows = document.querySelectorAll('#assetsTable tbody tr');

                rows.forEach(row => {
                    const assetTag = row.cells[0].textContent.toLowerCase();
                    const name = row.cells[1].textContent.toLowerCase();
                    const category = row.cells[2].textContent;
                    const status = row.cells[3].textContent;
                    const condition = row.cells[4].textContent;

                    const matchesSearch = assetTag.includes(searchTerm) || name.includes(searchTerm);
                    const matchesStatus = !statusValue || status === statusValue;
                    const matchesCategory = !categoryValue || category === categoryValue;
                    const matchesCondition = !conditionValue || condition === conditionValue;

                    row.style.display = (matchesSearch && matchesStatus && matchesCategory && matchesCondition) ? '' : 'none';
                });
            }

            if (applyFilters) {
                applyFilters.addEventListener('click', filterAssets);
            }

            if (clearFilters) {
                clearFilters.addEventListener('click', function() {
                    searchInput.value = '';
                    statusFilter.value = '';
                    categoryFilter.value = '';
                    conditionFilter.value = '';
                    filterAssets();
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', filterAssets);
            }

            // Show modal if ActiveModal is set
            @if (!string.IsNullOrEmpty(Model.ActiveModal))
            {
                    <text>
                    var modalElement = document.getElementById('@(Model.ActiveModal)Modal');
                    if (modalElement) {
                        var modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    }
                    </text>
            }
        });
    </script>
}

@functions {
    private string GetStatusBadgeClass(string status)
    {
        return status?.ToLower() switch
        {
            "active" => "bg-success",
            "inactive" => "bg-secondary",
            "maintenance" => "bg-warning",
            "retired" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetConditionBadgeClass(string condition)
    {
        return condition?.ToLower() switch
        {
            "new" => "bg-success",
            "good" => "bg-info",
            "fair" => "bg-warning",
            "poor" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}