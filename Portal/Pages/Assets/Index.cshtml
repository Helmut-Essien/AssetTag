@page
@model Portal.Pages.Assets.IndexModel
@{
    ViewData["Title"] = "Assets";
}

<div class="container my-4">
    <!-- Page Header with Asset Count and Add Button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">
        Assets 
        <span class="text-muted fs-5">
            (@(Model.Assets?.Count ?? 0) Total)
        </span>
    </h1>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="bi bi-plus-lg me-2"></i>Add Asset
    </button>
</div>

    <!-- Search and Filters Section -->
    <div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3" id="filterForm">
            <!-- Search Box -->
            <div class="col-12 col-md-4 mb-2 mb-md-0">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" asp-for="SearchTerm"
                           placeholder="Search assets, tags, serial numbers..."
                           id="searchInput" autocomplete="off">
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                            <i class="bi bi-x"></i>
                        </button>
                    }
                </div>
            </div>

            <!-- Quick Filters with Responsive Grid -->
            <div class="col-12 col-md-8">
                <div class="row g-2">
                    <!-- Status Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="statusFilter" class="form-label d-none d-md-block small mb-1">Status</label>
                            <select class="form-select form-select-sm" asp-for="StatusFilter"
                                    onchange="submitFilterForm()" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="Available">Available</option>
                                <option value="In Use">In Use</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Retired">Retired</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                    </div>

                    <!-- Condition Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="conditionFilter" class="form-label d-none d-md-block small mb-1">Condition</label>
                            <select class="form-select form-select-sm" asp-for="ConditionFilter"
                                    onchange="submitFilterForm()" id="conditionFilter">
                                <option value="">All Condition</option>
                                <option value="New">New</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                                <option value="Broken">Broken</option>
                            </select>
                        </div>
                    </div>

                    <!-- Category Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="categoryFilter" class="form-label d-none d-md-block small mb-1">Category</label>
                            <select class="form-select form-select-sm" asp-for="CategoryFilter"
                                    onchange="submitFilterForm()" id="categoryFilter">
                                <option value="">All Categories</option>
                                @foreach (var category in Model.Categories)
                                {
                                    <option value="@category.CategoryId">@category.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Location Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="locationFilter" class="form-label d-none d-md-block small mb-1">Location</label>
                            <select class="form-select form-select-sm" asp-for="LocationFilter"
                                    onchange="submitFilterForm()" id="locationFilter">
                                <option value="">All Locations</option>
                                @foreach (var location in Model.Locations)
                                {
                                    <option value="@location.LocationId">@location.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Department Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="departmentFilter" class="form-label d-none d-md-block small mb-1">Department</label>
                            <select class="form-select form-select-sm" asp-for="DepartmentFilter"
                                    onchange="submitFilterForm()" id="departmentFilter">
                                <option value="">All Departments</option>
                                @foreach (var department in Model.Departments)
                                {
                                    <option value="@department.DepartmentId">@department.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>


                <!-- Active Filters Display -->
@if (Model.HasActiveFilters)
{
    <div class="col-12 mt-2">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex flex-wrap gap-1">
                <small class="text-muted me-2">Active filters:</small>
                @if (!string.IsNullOrEmpty(Model.SearchTerm))
                {
                    <span class="badge bg-secondary">
                        Search: @Model.SearchTerm
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('SearchTerm')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.StatusFilter))
                {
                    <span class="badge bg-info">
                        Status: @Model.StatusFilter
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('StatusFilter')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.ConditionFilter))
                {
                    <span class="badge bg-warning text-dark">
                        Condition: @Model.ConditionFilter
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('ConditionFilter')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.CategoryFilter))
                {
                    <span class="badge bg-primary">
                        Category: @Model.GetCategoryName(Model.CategoryFilter)
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('CategoryFilter')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.LocationFilter))
                {
                    <span class="badge bg-success">
                        Location: @Model.GetLocationName(Model.LocationFilter)
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('LocationFilter')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.DepartmentFilter))
                {
                    <span class="badge bg-dark">
                        Department: @Model.GetDepartmentName(Model.DepartmentFilter)
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('DepartmentFilter')"></button>
                    </span>
                }
            </div>
            <div>
                <a href="@Url.Page("", new {
                    searchTerm = "",
                    statusFilter = "",
                    conditionFilter = "",
                    categoryFilter = "",
                    locationFilter = "",
                    departmentFilter = ""
                })" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-x-circle me-1"></i>Clear All
                </a>
            </div>
        </div>
    </div>
}
            </form>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="d-none text-center py-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-2">Filtering assets...</p>
    </div>

    <!-- Results Summary and Export Options -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span class="text-muted">
                Showing (@(Model.Assets?.Count ?? 0) assets
                @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.StatusFilter))
                {
                    <span>(filtered)</span>
                }
            </span>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download me-1"></i>Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportToCsv()">Export to CSV</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportToExcel()">Export to Excel</a></li>
            </ul>
        </div>
    </div>

    <!-- Assets Table -->
    
    <div class="table-responsive">
    @if (Model.Assets?.Any() == true)
    {
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Asset Tag</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Location</th>
                    <th>Department</th>
                    <th>Status</th>
                    <th>Condition</th>
                    <th>Purchase Date</th>
                    <th>Value</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var asset in Model.Assets)
                {
                    <tr>
                        <td>
                            <strong>@asset.AssetTag</strong>
                            @if (!string.IsNullOrEmpty(asset.SerialNumber))
                            {
                                <br />
                                <small class="text-muted">SN: @asset.SerialNumber</small>
                            }
                        </td>
                        <td>@asset.Name</td>
                        <td>@(string.IsNullOrEmpty(asset.Description) ? "No description" : asset.Description)</td>
                        <td>@Model.GetCategoryName(asset.CategoryId)</td>
                        <td>@Model.GetLocationName(asset.LocationId)</td>
                        <td>@Model.GetDepartmentName(asset.DepartmentId)</td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(asset.Status)">
                                @asset.Status
                            </span>
                        </td>
                        <td>
                            <span class="badge @GetConditionBadgeClass(asset.Condition)">
                                @asset.Condition
                            </span>
                        </td>
                        <td>@asset.PurchaseDate?.ToString("MMM dd, yyyy")</td>
                        <td>
                            @if (asset.NetBookValue.HasValue)
                            {
                                <text>₵@asset.NetBookValue.Value.ToString("N2")</text>
                            }
                            else
                            {
                                <span class="text-muted">N/A</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a asp-page="./Details" asp-route-id="@asset.AssetId" class="btn btn-info btn-sm me-1">
                                    <i class="bi bi-eye"></i> View
                                </a>
                                <button class="btn btn-primary btn-sm me-1"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editModal"
                                        data-id="@asset.AssetId"
                                        data-assettag="@asset.AssetTag"
                                        data-name="@asset.Name"
                                        data-desc="@asset.Description"
                                        data-categoryid="@asset.CategoryId"
                                        data-locationid="@asset.LocationId"
                                        data-departmentid="@asset.DepartmentId"
                                        data-purchasedate="@asset.PurchaseDate?.ToString("yyyy-MM-dd")"
                                        data-purchaseprice="@asset.PurchasePrice"
                                        data-status="@asset.Status"
                                        data-assignedtouserid="@asset.AssignedToUserId"
                                        data-serialnumber="@asset.SerialNumber"
                                        data-condition="@asset.Condition"
                                        data-vendorname="@asset.VendorName"
                                        data-invoicenumber="@asset.InvoiceNumber"
                                        data-quantity="@asset.Quantity"
                                        data-costperunit="@asset.CostPerUnit"
                                        data-depreciationrate="@asset.DepreciationRate"
                                        data-calculatedusefullifeyears="@asset.CalculatedUsefulLifeYears"
                                        data-warrantyexpiry="@asset.WarrantyExpiry?.ToString("yyyy-MM-dd")"
                                        data-disposaldate="@asset.DisposalDate?.ToString("yyyy-MM-dd")"
                                        data-disposalvalue="@asset.DisposalValue"
                                        data-remarks="@asset.Remarks">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModal"
                                        data-id="@asset.AssetId">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No assets found. 
            @if (Model.HasActiveFilters)
            {
                <text>Try clearing your filters or </text>
            }
            <a href="#" data-bs-toggle="modal" data-bs-target="#createModal">create a new asset</a>.
        </div>
    }
</div>

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Available" => "bg-success",
            "In Use" => "bg-primary",
            "Under Maintenance" => "bg-warning",
            "Retired" => "bg-secondary",
            "Lost" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetConditionBadgeClass(string condition)
    {
        return condition switch
        {
            "New" => "bg-success",
            "Good" => "bg-info",
            "Fair" => "bg-warning",
            "Poor" => "bg-danger",
            "Broken" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}
</div>

<!-- Create Asset Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Create New Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="Create">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>

                    <!-- Basic Information Section -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.AssetTag" class="form-label"></label>
                                <input asp-for="CreateDto.AssetTag" class="form-control" />
                                <span asp-validation-for="CreateDto.AssetTag" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Name" class="form-label"></label>
                                <input asp-for="CreateDto.Name" class="form-control" />
                                <span asp-validation-for="CreateDto.Name" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="CreateDto.Description" class="form-label"></label>
                        <textarea asp-for="CreateDto.Description" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="CreateDto.Description" class="text-danger"></span>
                    </div>

                    <!-- Category, Location, Department Selection -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for = "CreateDto.CategoryId" class="form-label"></label>
                                <select asp-for="CreateDto.CategoryId" class="form-select">
                                    <option value="">Select Category</option>
                                    @foreach (var category in Model.Categories)
                                    {
                                        <option value="@category.CategoryId">@category.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.LocationId" class="form-label"></label>
                                <select asp-for="CreateDto.LocationId" class="form-select">
                                    <option value="">Select Location</option>
                                    @foreach (var location in Model.Locations)
                                    {
                                        <option value="@location.LocationId">@location.Name - @location.Campus</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.LocationId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.DepartmentId" class="form-label"></label>
                                <select asp-for="CreateDto.DepartmentId" class="form-select">
                                    <option value="">Select Department</option>
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department.DepartmentId">@department.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.DepartmentId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Status and Condition Selection -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Status" class="form-label"></label>
                                <select asp-for="CreateDto.Status" class="form-select">
                                    <option value="Available">Available</option>
                                    <option value="In Use">In Use</option>
                                    <option value="Under Maintenance">Under Maintenance</option>
                                    <option value="Retired">Retired</option>
                                    <option value="Lost">Lost</option>
                                </select>
                                <span asp-validation-for="CreateDto.Status" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Condition" class="form-label"></label>
                                <select asp-for="CreateDto.Condition" class="form-select">
                                    <option value="New">New</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                    <option value="Broken">Broken</option>
                                </select>
                                <span asp-validation-for="CreateDto.Condition" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Purchase and Serial Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.PurchaseDate" class="form-label"></label>
                                <input asp-for="CreateDto.PurchaseDate" type="date" class="form-control" />
                                <span asp-validation-for="CreateDto.PurchaseDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.SerialNumber" class="form-label"></label>
                                <input asp-for="CreateDto.SerialNumber" class="form-control" />
                                <span asp-validation-for="CreateDto.SerialNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Financial Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.PurchasePrice" class="form-label"></label>
                                <input asp-for="CreateDto.PurchasePrice" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.PurchasePrice" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Quantity" class="form-label"></label>
                                <input asp-for="CreateDto.Quantity" type="number" class="form-control" />
                                <span asp-validation-for="CreateDto.Quantity" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Financial Information Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Financial Information</h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.CostPerUnit" class="form-label"></label>
                                <input asp-for="CreateDto.CostPerUnit" type="number" step="0.01" class="form-control" id="createCostPerUnit" />
                                <span asp-validation-for="CreateDto.CostPerUnit" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Total Cost (Calculated)</label>
                                <input type="text" class="form-control" id="createTotalCostDisplay" readonly disabled style="background-color: #e9ecef;" />
                                <small class="text-muted">Auto-calculated: Cost Per Unit × Quantity</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Useful Life (Years)</label>
                                <input type="text" class="form-control" value="Auto-calculated from category" readonly disabled style="background-color: #e9ecef;" />
                                <small class="text-muted">Calculated: 100 ÷ Category Depreciation Rate</small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> Depreciation rate is automatically set based on the selected category.
                        Accumulated Depreciation and Net Book Value are calculated automatically.
                    </div>

                    <!-- Additional Information Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Additional Information</h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.VendorName" class="form-label"></label>
                                <input asp-for="CreateDto.VendorName" class="form-control" />
                                <span asp-validation-for="CreateDto.VendorName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.InvoiceNumber" class="form-label"></label>
                                <input asp-for="CreateDto.InvoiceNumber" class="form-control" />
                                <span asp-validation-for="CreateDto.InvoiceNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.WarrantyExpiry" class="form-label"></label>
                                <input asp-for="CreateDto.WarrantyExpiry" type="date" class="form-control" />
                                <span asp-validation-for="CreateDto.WarrantyExpiry" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.DisposalDate" class="form-label"></label>
                                <input asp-for="CreateDto.DisposalDate" type="date" class="form-control" />
                                <span asp-validation-for="CreateDto.DisposalDate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.DisposalValue" class="form-label"></label>
                                <input asp-for="CreateDto.DisposalValue" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.DisposalValue" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Remarks" class="form-label"></label>
                                <textarea asp-for="CreateDto.Remarks" class="form-control" rows="2"></textarea>
                                <span asp-validation-for="CreateDto.Remarks" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">Create Asset</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Asset Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="Update">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>
                    <input type="hidden" asp-for="UpdateDto.AssetId" />

                    <!-- Basic Information Section -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.AssetTag" class="form-label"></label>
                                <input asp-for="UpdateDto.AssetTag" class="form-control" />
                                <span asp-validation-for="UpdateDto.AssetTag" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Name" class="form-label"></label>
                                <input asp-for="UpdateDto.Name" class="form-control" />
                                <span asp-validation-for="UpdateDto.Name" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="UpdateDto.Description" class="form-label"></label>
                        <textarea asp-for="UpdateDto.Description" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="UpdateDto.Description" class="text-danger"></span>
                    </div>

                    <!-- Category, Location, Department Selection -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.CategoryId" class="form-label"></label>
                                <select asp-for="UpdateDto.CategoryId" class="form-select">
                                    <option value="">Select Category</option>
                                    @foreach (var category in Model.Categories)
                                    {
                                        <option value="@category.CategoryId">@category.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.LocationId" class="form-label"></label>
                                <select asp-for="UpdateDto.LocationId" class="form-select">
                                    <option value="">Select Location</option>
                                    @foreach (var location in Model.Locations)
                                    {
                                        <option value="@location.LocationId">@location.Name - @location.Campus</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.LocationId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DepartmentId" class="form-label"></label>
                                <select asp-for="UpdateDto.DepartmentId" class="form-select">
                                    <option value="">Select Department</option>
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department.DepartmentId">@department.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.DepartmentId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Status and Condition Selection -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Status" class="form-label"></label>
                                <select asp-for="UpdateDto.Status" class="form-select">
                                    <option value="Available">Available</option>
                                    <option value="In Use">In Use</option>
                                    <option value="Under Maintenance">Under Maintenance</option>
                                    <option value="Retired">Retired</option>
                                    <option value="Lost">Lost</option>
                                </select>
                                <span asp-validation-for="UpdateDto.Status" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Condition" class="form-label"></label>
                                <select asp-for="UpdateDto.Condition" class="form-select">
                                    <option value="New">New</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                    <option value="Broken">Broken</option>
                                </select>
                                <span asp-validation-for="UpdateDto.Condition" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Purchase and Serial Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.PurchaseDate" class="form-label"></label>
                                <input asp-for="UpdateDto.PurchaseDate" type="date" class="form-control" />
                                <span asp-validation-for="UpdateDto.PurchaseDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.SerialNumber" class="form-label"></label>
                                <input asp-for="UpdateDto.SerialNumber" class="form-control" />
                                <span asp-validation-for="UpdateDto.SerialNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Financial Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.PurchasePrice" class="form-label"></label>
                                <input asp-for="UpdateDto.PurchasePrice" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.PurchasePrice" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Quantity" class="form-label"></label>
                                <input asp-for="UpdateDto.Quantity" type="number" class="form-control" />
                                <span asp-validation-for="UpdateDto.Quantity" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Financial Information Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Financial Information</h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.CostPerUnit" class="form-label"></label>
                                <input asp-for="UpdateDto.CostPerUnit" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.CostPerUnit" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Useful Life (Years)</label>
                                <input type="text" class="form-control" id="editUsefulLifeDisplay" readonly disabled style="background-color: #e9ecef;" />
                                <small class="text-muted">Auto-calculated from category depreciation rate</small>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Additional Information</h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.VendorName" class="form-label"></label>
                                <input asp-for="UpdateDto.VendorName" class="form-control" />
                                <span asp-validation-for="UpdateDto.VendorName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.InvoiceNumber" class="form-label"></label>
                                <input asp-for="UpdateDto.InvoiceNumber" class="form-control" />
                                <span asp-validation-for="UpdateDto.InvoiceNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.WarrantyExpiry" class="form-label"></label>
                                <input asp-for="UpdateDto.WarrantyExpiry" type="date" class="form-control" />
                                <span asp-validation-for="UpdateDto.WarrantyExpiry" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DisposalDate" class="form-label"></label>
                                <input asp-for="UpdateDto.DisposalDate" type="date" class="form-control" />
                                <span asp-validation-for="UpdateDto.DisposalDate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DisposalValue" class="form-label"></label>
                                <input asp-for="UpdateDto.DisposalValue" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.DisposalValue" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Remarks" class="form-label"></label>
                                <textarea asp-for="UpdateDto.Remarks" class="form-control" rows="2"></textarea>
                                <span asp-validation-for="UpdateDto.Remarks" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">Update Asset</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this asset? This action cannot be undone.</p>
                <form method="post" asp-page-handler="Delete">
                    <input type="hidden" name="id" id="deleteId" />
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Performance-optimized search and filter functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
            restoreFilterState();

            // Initialize Bootstrap modals
            initializeModals();
        });

        function initializeFilters() {
            const searchInput = document.getElementById('searchInput');
            const filterForm = document.getElementById('filterForm');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const assetsTable = document.querySelector('.table-responsive');

            // Debounced search with loading indicator
            if (searchInput) {
                const debouncedSearch = debounce(function() {
                    showLoading();
                    filterForm.submit();
                }, 600);

                searchInput.addEventListener('input', debouncedSearch);
            }

            // Store filter state before submission
            filterForm.addEventListener('submit', function() {
                saveFilterState();
            });
        }

        function initializeModals() {
            // Check URL for modal trigger
    const urlParams = new URLSearchParams(window.location.search);
    const openCreateModal = urlParams.get('openCreateModal');
    const activeModal = urlParams.get('ActiveModal');
    const editAssetId = urlParams.get('editAssetId');
    
    // Handle Create Modal linked from other pages
    if (openCreateModal === 'true') {
        // Clean the URL first
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // Use Bootstrap's built-in method - simulate clicking the Add Asset button
        setTimeout(() => {
            const addAssetButton = document.querySelector('button[data-bs-target="#createModal"]');
            if (addAssetButton) {
                addAssetButton.click();
            }
        }, 100);
    }


    // Handle Edit Modal linked from other pages
    if (editAssetId) {
        // Clean the URL first
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // Fetch asset data and open edit modal
        setTimeout(() => {
            fetchAssetAndOpenEditModal(editAssetId);
        }, 100);
    }

    // Rest of your existing modal initialization code...
}

function fetchAssetAndOpenEditModal(assetId) {
    // You have two options here:
    
    // Option 1: If the asset is already in the table, find and click its edit button
    const editButton = document.querySelector(`button[data-id="${assetId}"][data-bs-target="#editModal"]`);
    if (editButton) {
        editButton.click();
    } else {
        // Option 2: Fetch the asset from API and populate the modal
        // This is necessary if the asset isn't on the current page due to filtering/pagination
        fetch(`/api/assets/${assetId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Asset not found');
                }
                return response.json();
            })
            .then(asset => {
                populateEditModal(asset);
                const editModal = new bootstrap.Modal(document.getElementById('editModal'), {
                    backdrop: true,
                    keyboard: true
                });
                editModal.show();
            })
            .catch(error => {
                console.error('Error fetching asset:', error);
                alert('Could not load asset for editing. Please make sure it exists and you have permission.');
            });
    }
}

function populateEditModal(asset) {
    // Populate all form fields from the asset object
    document.getElementById('UpdateDto_AssetId').value = asset.assetId || '';
    document.getElementById('UpdateDto_AssetTag').value = asset.assetTag || '';
    document.getElementById('UpdateDto_Name').value = asset.name || '';
    document.getElementById('UpdateDto_Description').value = asset.description || '';
    document.getElementById('UpdateDto_CategoryId').value = asset.categoryId || '';
    document.getElementById('UpdateDto_LocationId').value = asset.locationId || '';
    document.getElementById('UpdateDto_DepartmentId').value = asset.departmentId || '';
    document.getElementById('UpdateDto_PurchaseDate').value = asset.purchaseDate ? asset.purchaseDate.split('T')[0] : '';
    document.getElementById('UpdateDto_PurchasePrice').value = asset.purchasePrice || '';
    document.getElementById('UpdateDto_Status').value = asset.status || '';
    document.getElementById('UpdateDto_SerialNumber').value = asset.serialNumber || '';
    document.getElementById('UpdateDto_Condition').value = asset.condition || '';
    document.getElementById('UpdateDto_Quantity').value = asset.quantity || '1';
    document.getElementById('UpdateDto_CostPerUnit').value = asset.costPerUnit || '';
    // Display calculated useful life years (read-only)
    const calculatedUsefulLife = asset.calculatedUsefulLifeYears ||
                                 (asset.depreciationRate && asset.depreciationRate > 0 ?
                                  Math.ceil(100 / asset.depreciationRate) : 'N/A');
    document.getElementById('editUsefulLifeDisplay').value = calculatedUsefulLife + (typeof calculatedUsefulLife === 'number' ? ' years' : '');
    document.getElementById('UpdateDto_VendorName').value = asset.vendorName || '';
    document.getElementById('UpdateDto_InvoiceNumber').value = asset.invoiceNumber || '';
    document.getElementById('UpdateDto_WarrantyExpiry').value = asset.warrantyExpiry ? asset.warrantyExpiry.split('T')[0] : '';
    document.getElementById('UpdateDto_DisposalDate').value = asset.disposalDate ? asset.disposalDate.split('T')[0] : '';
    document.getElementById('UpdateDto_DisposalValue').value = asset.disposalValue || '';
    document.getElementById('UpdateDto_Remarks').value = asset.remarks || '';
}

// Also update your existing edit modal event listener to use the same function
var editModal = document.getElementById('editModal');
if (editModal) {
    editModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var asset = {
            assetId: button.getAttribute('data-id'),
            assetTag: button.getAttribute('data-assettag'),
            name: button.getAttribute('data-name'),
            description: button.getAttribute('data-desc'),
            categoryId: button.getAttribute('data-categoryid'),
            locationId: button.getAttribute('data-locationid'),
            departmentId: button.getAttribute('data-departmentid'),
            purchaseDate: button.getAttribute('data-purchasedate'),
            purchasePrice: button.getAttribute('data-purchaseprice'),
            status: button.getAttribute('data-status'),
            serialNumber: button.getAttribute('data-serialnumber'),
            condition: button.getAttribute('data-condition'),
            quantity: button.getAttribute('data-quantity'),
            costPerUnit: button.getAttribute('data-costperunit'),
            depreciationRate: button.getAttribute('data-depreciationrate'),
            calculatedUsefulLifeYears: button.getAttribute('data-calculatedusefullifeyears'),
            vendorName: button.getAttribute('data-vendorname'),
            invoiceNumber: button.getAttribute('data-invoicenumber'),
            warrantyExpiry: button.getAttribute('data-warrantyexpiry'),
            disposalDate: button.getAttribute('data-disposaldate'),
            disposalValue: button.getAttribute('data-disposalvalue'),
            remarks: button.getAttribute('data-remarks')
        };
        populateEditModal(asset);
    });
           

            // Delete Modal - Set asset ID for deletion
            var deleteModal = document.getElementById('deleteModal');
            if (deleteModal) {
                deleteModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var id = button.getAttribute('data-id');
                    document.getElementById('deleteId').value = id;
                });
            }

            // Show specific modal if ActiveModal is set (for validation errors)
            @if (!string.IsNullOrEmpty(Model.ActiveModal))
            {
                    <text>
                    var modalElement = document.getElementById('@(Model.ActiveModal)Modal');
                    if (modalElement) {
                        var modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    }
                    </text>
            }
        }

        function submitFilterForm() {
            showLoading();
            document.getElementById('filterForm').submit();
        }

        function showLoading() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const assetsTable = document.querySelector('.table-responsive');

            if (loadingIndicator && assetsTable) {
                loadingIndicator.classList.remove('d-none');
                assetsTable.style.opacity = '0.5';
            }
        }

        function removeFilter(filterName) {
            const url = new URL(window.location.href);
            url.searchParams.delete(filterName);
            window.location.href = url.toString();
        }

        function clearAllFilters() {
            const url = new URL(window.location.href);
            // Remove all filter parameters
            ['SearchTerm', 'StatusFilter', 'ConditionFilter', 'CategoryFilter', 'LocationFilter', 'DepartmentFilter']
                .forEach(param => url.searchParams.delete(param));
            window.location.href = url.toString();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            submitFilterForm();
        }

        // Save and restore filter state
        function saveFilterState() {
            const filters = {
                searchTerm: document.getElementById('searchInput')?.value,
                status: document.getElementById('statusFilter')?.value,
                condition: document.getElementById('conditionFilter')?.value,
                category: document.getElementById('categoryFilter')?.value,
                location: document.getElementById('locationFilter')?.value,
                department: document.getElementById('departmentFilter')?.value
            };
            sessionStorage.setItem('assetFilters', JSON.stringify(filters));
        }

        function restoreFilterState() {
            try {
                const saved = sessionStorage.getItem('assetFilters');
                if (saved) {
                    const filters = JSON.parse(saved);

                    // Only restore if no current filters in URL
                    const urlParams = new URLSearchParams(window.location.search);
                    if (!urlParams.toString()) {
                        if (filters.searchTerm) document.getElementById('searchInput').value = filters.searchTerm;
                        if (filters.status) document.getElementById('statusFilter').value = filters.status;
                        if (filters.condition) document.getElementById('conditionFilter').value = filters.condition;
                        if (filters.category) document.getElementById('categoryFilter').value = filters.category;
                        if (filters.location) document.getElementById('locationFilter').value = filters.location;
                        if (filters.department) document.getElementById('departmentFilter').value = filters.department;
                    }
                }
            } catch (e) {
                console.warn('Could not restore filter state:', e);
            }
        }

        // Enhanced debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Enhanced export with current filters
        function exportToCsv() {
            const currentParams = new URLSearchParams(window.location.search);
            currentParams.set('format', 'csv');
            currentParams.set('handler', 'export');
            window.location.href = `?${currentParams.toString()}`;
        }

        function exportToExcel() {
            const currentParams = new URLSearchParams(window.location.search);
            currentParams.set('format', 'excel');
            currentParams.set('handler', 'export');
            window.location.href = `?${currentParams.toString()}`;
        }

        // Auto-calculate Total Cost in Create Modal
        function calculateTotalCost() {
            const costPerUnit = parseFloat(document.getElementById('createCostPerUnit')?.value || 0);
            const quantity = parseInt(document.getElementById('CreateDto_Quantity')?.value || 1);
            const totalCostDisplay = document.getElementById('createTotalCostDisplay');
            
            if (totalCostDisplay && costPerUnit > 0) {
                const totalCost = costPerUnit * quantity;
                totalCostDisplay.value = '₵ ' + totalCost.toLocaleString('en-GH', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } else if (totalCostDisplay) {
                totalCostDisplay.value = '';
            }
        }

        // Attach event listeners for auto-calculation
        document.addEventListener('DOMContentLoaded', function() {
            const costPerUnitInput = document.getElementById('createCostPerUnit');
            const quantityInput = document.getElementById('CreateDto_Quantity');
            
            if (costPerUnitInput) {
                costPerUnitInput.addEventListener('input', calculateTotalCost);
            }
            if (quantityInput) {
                quantityInput.addEventListener('input', calculateTotalCost);
            }
        });
    </script>
}