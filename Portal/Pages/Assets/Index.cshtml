@page
@model Portal.Pages.Assets.IndexModel
@{
    ViewData["Title"] = "Assets";
}

<div class="container my-4">
    <!-- Page Header with Asset Count and Add Button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">
        Assets 
        <span class="text-muted fs-5">
            (@(Model.Assets?.Count ?? 0) Total)
        </span>
    </h1>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="bi bi-plus-lg me-2"></i>Add Asset
    </button>
</div>

    <!-- Search and Filters Section -->
    <div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3" id="filterForm">
            <!-- Search Box -->
            <div class="col-12 col-md-4 mb-2 mb-md-0">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" asp-for="SearchTerm"
                           placeholder="Search assets, tags, serial numbers..."
                           id="searchInput" autocomplete="off">
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                            <i class="bi bi-x"></i>
                        </button>
                    }
                </div>
            </div>

            <!-- Quick Filters with Responsive Grid -->
            <div class="col-12 col-md-8">
                <div class="row g-2">
                    <!-- Status Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="statusFilter" class="form-label d-none d-md-block small mb-1">Status</label>
                            <select class="form-select form-select-sm" asp-for="StatusFilter"
                                    onchange="submitFilterForm()" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="Available">Available</option>
                                <option value="In Use">In Use</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Retired">Retired</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                    </div>

                    <!-- Condition Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="conditionFilter" class="form-label d-none d-md-block small mb-1">Condition</label>
                            <select class="form-select form-select-sm" asp-for="ConditionFilter"
                                    onchange="submitFilterForm()" id="conditionFilter">
                                <option value="">All Condition</option>
                                <option value="New">New</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                                <option value="Broken">Broken</option>
                            </select>
                        </div>
                    </div>

                    <!-- Category Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="categoryFilter" class="form-label d-none d-md-block small mb-1">Category</label>
                            <select class="form-select form-select-sm" asp-for="CategoryFilter"
                                    onchange="submitFilterForm()" id="categoryFilter">
                                <option value="">All Categories</option>
                                @foreach (var category in Model.Categories)
                                {
                                    <option value="@category.CategoryId">@category.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Location Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="locationFilter" class="form-label d-none d-md-block small mb-1">Location</label>
                            <select class="form-select form-select-sm" asp-for="LocationFilter"
                                    onchange="submitFilterForm()" id="locationFilter">
                                <option value="">All Locations</option>
                                @foreach (var location in Model.Locations)
                                {
                                    <option value="@location.LocationId">@location.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Department Filter -->
                    <div class="col-6 col-sm-4 col-lg">
                        <div class="filter-select-wrapper">
                            <label for="departmentFilter" class="form-label d-none d-md-block small mb-1">Department</label>
                            <select class="form-select form-select-sm" asp-for="DepartmentFilter"
                                    onchange="submitFilterForm()" id="departmentFilter">
                                <option value="">All Departments</option>
                                @foreach (var department in Model.Departments)
                                {
                                    <option value="@department.DepartmentId">@department.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>


                <!-- Active Filters Display -->
@if (Model.HasActiveFilters)
{
    <div class="col-12 mt-2">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex flex-wrap gap-1">
                <small class="text-muted me-2">Active filters:</small>
                @if (!string.IsNullOrEmpty(Model.SearchTerm))
                {
                    <span class="badge bg-secondary">
                        Search: @Model.SearchTerm
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('SearchTerm')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.StatusFilter))
                {
                    <span class="badge bg-info">
                        Status: @Model.StatusFilter
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('StatusFilter')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.ConditionFilter))
                {
                    <span class="badge bg-warning text-dark">
                        Condition: @Model.ConditionFilter
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('ConditionFilter')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.CategoryFilter))
                {
                    <span class="badge bg-primary">
                        Category: @Model.GetCategoryName(Model.CategoryFilter)
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('CategoryFilter')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.LocationFilter))
                {
                    <span class="badge bg-success">
                        Location: @Model.GetLocationName(Model.LocationFilter)
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('LocationFilter')"></button>
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.DepartmentFilter))
                {
                    <span class="badge bg-dark">
                        Department: @Model.GetDepartmentName(Model.DepartmentFilter)
                        <button type="button" class="btn-close btn-close-white ms-1"
                                onclick="removeFilter('DepartmentFilter')"></button>
                    </span>
                }
            </div>
            <div>
                <a href="@Url.Page("", new {
                    searchTerm = "",
                    statusFilter = "",
                    conditionFilter = "",
                    categoryFilter = "",
                    locationFilter = "",
                    departmentFilter = ""
                })" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-x-circle me-1"></i>Clear All
                </a>
            </div>
        </div>
    </div>
}
            </form>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="d-none text-center py-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-2">Filtering assets...</p>
    </div>

    <!-- Results Summary and Export Options -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span class="text-muted">
                Showing (@(Model.Assets?.Count ?? 0) assets
                @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.StatusFilter))
                {
                    <span>(filtered)</span>
                }
            </span>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download me-1"></i>Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportToCsv()">Export to CSV</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportToExcel()">Export to Excel</a></li>
            </ul>
        </div>
    </div>

    <!-- Assets Table -->
    
    <div class="table-responsive">
    @if (Model.Assets?.Any() == true)
    {
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Asset Tag</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Location</th>
                    <th>Department</th>
                    <th>Status</th>
                    <th>Condition</th>
                    <th>Purchase Date</th>
                    <th>Value</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var asset in Model.Assets)
                {
                    <tr>
                        <td>
                            <strong>@asset.AssetTag</strong>
                            @if (!string.IsNullOrEmpty(asset.SerialNumber))
                            {
                                <br />
                                <small class="text-muted">SN: @asset.SerialNumber</small>
                            }
                        </td>
                        <td>@asset.Name</td>
                        <td>@(string.IsNullOrEmpty(asset.Description) ? "No description" : asset.Description)</td>
                        <td>@Model.GetCategoryName(asset.CategoryId)</td>
                        <td>@Model.GetLocationName(asset.LocationId)</td>
                        <td>@Model.GetDepartmentName(asset.DepartmentId)</td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(asset.Status)">
                                @asset.Status
                            </span>
                        </td>
                        <td>
                            <span class="badge @GetConditionBadgeClass(asset.Condition)">
                                @asset.Condition
                            </span>
                        </td>
                        <td>@asset.PurchaseDate?.ToString("MMM dd, yyyy")</td>
                        <td>
                            @if (asset.CurrentValue.HasValue)
                            {
                                <text>@asset.CurrentValue.Value.ToString("C")</text>
                            }
                            else
                            {
                                <span class="text-muted">N/A</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a asp-page="./Details" asp-route-id="@asset.AssetId" class="btn btn-info btn-sm me-1">
                                    <i class="bi bi-eye"></i> View
                                </a>
                                <button class="btn btn-primary btn-sm me-1"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editModal"
                                        data-id="@asset.AssetId"
                                        data-assettag="@asset.AssetTag"
                                        data-name="@asset.Name"
                                        data-desc="@asset.Description"
                                        data-categoryid="@asset.CategoryId"
                                        data-locationid="@asset.LocationId"
                                        data-departmentid="@asset.DepartmentId"
                                        data-purchasedate="@asset.PurchaseDate?.ToString("yyyy-MM-dd")"
                                        data-purchaseprice="@asset.PurchasePrice"
                                        data-currentvalue="@asset.CurrentValue"
                                        data-status="@asset.Status"
                                        data-assignedtouserid="@asset.AssignedToUserId"
                                        data-serialnumber="@asset.SerialNumber"
                                        data-condition="@asset.Condition"
                                        data-vendorname="@asset.VendorName"
                                        data-invoicenumber="@asset.InvoiceNumber"
                                        data-quantity="@asset.Quantity"
                                        data-costperunit="@asset.CostPerUnit"
                                        data-totalcost="@asset.TotalCost"
                                        data-depreciationrate="@asset.DepreciationRate"
                                        data-accumulateddepreciation="@asset.AccumulatedDepreciation"
                                        data-netbookvalue="@asset.NetBookValue"
                                        data-usefullifeyears="@asset.UsefulLifeYears"
                                        data-warrantyexpiry="@asset.WarrantyExpiry?.ToString("yyyy-MM-dd")"
                                        data-disposaldate="@asset.DisposalDate?.ToString("yyyy-MM-dd")"
                                        data-disposalvalue="@asset.DisposalValue"
                                        data-remarks="@asset.Remarks">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModal"
                                        data-id="@asset.AssetId">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No assets found. 
            @if (Model.HasActiveFilters)
            {
                <text>Try clearing your filters or </text>
            }
            <a href="#" data-bs-toggle="modal" data-bs-target="#createModal">create a new asset</a>.
        </div>
    }
</div>

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Available" => "bg-success",
            "In Use" => "bg-primary",
            "Under Maintenance" => "bg-warning",
            "Retired" => "bg-secondary",
            "Lost" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetConditionBadgeClass(string condition)
    {
        return condition switch
        {
            "New" => "bg-success",
            "Good" => "bg-info",
            "Fair" => "bg-warning",
            "Poor" => "bg-danger",
            "Broken" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}
</div>

<!-- Create Asset Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Create New Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="Create">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>

                    <!-- Basic Information Section -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.AssetTag" class="form-label"></label>
                                <input asp-for="CreateDto.AssetTag" class="form-control" />
                                <span asp-validation-for="CreateDto.AssetTag" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Name" class="form-label"></label>
                                <input asp-for="CreateDto.Name" class="form-control" />
                                <span asp-validation-for="CreateDto.Name" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="CreateDto.Description" class="form-label"></label>
                        <textarea asp-for="CreateDto.Description" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="CreateDto.Description" class="text-danger"></span>
                    </div>

                    <!-- Category, Location, Department Selection -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for = "CreateDto.CategoryId" class="form-label"></label>
                                <select asp-for="CreateDto.CategoryId" class="form-select">
                                    <option value="">Select Category</option>
                                    @foreach (var category in Model.Categories)
                                    {
                                        <option value="@category.CategoryId">@category.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.LocationId" class="form-label"></label>
                                <select asp-for="CreateDto.LocationId" class="form-select">
                                    <option value="">Select Location</option>
                                    @foreach (var location in Model.Locations)
                                    {
                                        <option value="@location.LocationId">@location.Name - @location.Campus</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.LocationId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.DepartmentId" class="form-label"></label>
                                <select asp-for="CreateDto.DepartmentId" class="form-select">
                                    <option value="">Select Department</option>
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department.DepartmentId">@department.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="CreateDto.DepartmentId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Status and Condition Selection -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Status" class="form-label"></label>
                                <select asp-for="CreateDto.Status" class="form-select">
                                    <option value="Available">Available</option>
                                    <option value="In Use">In Use</option>
                                    <option value="Under Maintenance">Under Maintenance</option>
                                    <option value="Retired">Retired</option>
                                    <option value="Lost">Lost</option>
                                </select>
                                <span asp-validation-for="CreateDto.Status" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Condition" class="form-label"></label>
                                <select asp-for="CreateDto.Condition" class="form-select">
                                    <option value="New">New</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                    <option value="Broken">Broken</option>
                                </select>
                                <span asp-validation-for="CreateDto.Condition" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Purchase and Serial Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.PurchaseDate" class="form-label"></label>
                                <input asp-for="CreateDto.PurchaseDate" type="date" class="form-control" />
                                <span asp-validation-for="CreateDto.PurchaseDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.SerialNumber" class="form-label"></label>
                                <input asp-for="CreateDto.SerialNumber" class="form-control" />
                                <span asp-validation-for="CreateDto.SerialNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Financial Information -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.PurchasePrice" class="form-label"></label>
                                <input asp-for="CreateDto.PurchasePrice" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.PurchasePrice" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.CurrentValue" class="form-label"></label>
                                <input asp-for="CreateDto.CurrentValue" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.CurrentValue" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Quantity" class="form-label"></label>
                                <input asp-for="CreateDto.Quantity" type="number" class="form-control" />
                                <span asp-validation-for="CreateDto.Quantity" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Financial Information Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Financial Information</h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.CostPerUnit" class="form-label"></label>
                                <input asp-for="CreateDto.CostPerUnit" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.CostPerUnit" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.TotalCost" class="form-label"></label>
                                <input asp-for="CreateDto.TotalCost" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.TotalCost" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.DepreciationRate" class="form-label"></label>
                                <input asp-for="CreateDto.DepreciationRate" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.DepreciationRate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.AccumulatedDepreciation" class="form-label"></label>
                                <input asp-for="CreateDto.AccumulatedDepreciation" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.AccumulatedDepreciation" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.NetBookValue" class="form-label"></label>
                                <input asp-for="CreateDto.NetBookValue" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.NetBookValue" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="CreateDto.UsefulLifeYears" class="form-label"></label>
                                <input asp-for="CreateDto.UsefulLifeYears" type="number" class="form-control" />
                                <span asp-validation-for="CreateDto.UsefulLifeYears" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Additional Information</h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.VendorName" class="form-label"></label>
                                <input asp-for="CreateDto.VendorName" class="form-control" />
                                <span asp-validation-for="CreateDto.VendorName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.InvoiceNumber" class="form-label"></label>
                                <input asp-for="CreateDto.InvoiceNumber" class="form-control" />
                                <span asp-validation-for="CreateDto.InvoiceNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.WarrantyExpiry" class="form-label"></label>
                                <input asp-for="CreateDto.WarrantyExpiry" type="date" class="form-control" />
                                <span asp-validation-for="CreateDto.WarrantyExpiry" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.DisposalDate" class="form-label"></label>
                                <input asp-for="CreateDto.DisposalDate" type="date" class="form-control" />
                                <span asp-validation-for="CreateDto.DisposalDate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CreateDto.DisposalValue" class="form-label"></label>
                                <input asp-for="CreateDto.DisposalValue" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="CreateDto.DisposalValue" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label asp-for="CreateDto.Remarks" class="form-label"></label>
                                <textarea asp-for="CreateDto.Remarks" class="form-control" rows="2"></textarea>
                                <span asp-validation-for="CreateDto.Remarks" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">Create Asset</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Asset Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="Update">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>
                    <input type="hidden" asp-for="UpdateDto.AssetId" />

                    <!-- Basic Information Section -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.AssetTag" class="form-label"></label>
                                <input asp-for="UpdateDto.AssetTag" class="form-control" />
                                <span asp-validation-for="UpdateDto.AssetTag" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Name" class="form-label"></label>
                                <input asp-for="UpdateDto.Name" class="form-control" />
                                <span asp-validation-for="UpdateDto.Name" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="UpdateDto.Description" class="form-label"></label>
                        <textarea asp-for="UpdateDto.Description" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="UpdateDto.Description" class="text-danger"></span>
                    </div>

                    <!-- Category, Location, Department Selection -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.CategoryId" class="form-label"></label>
                                <select asp-for="UpdateDto.CategoryId" class="form-select">
                                    <option value="">Select Category</option>
                                    @foreach (var category in Model.Categories)
                                    {
                                        <option value="@category.CategoryId">@category.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.LocationId" class="form-label"></label>
                                <select asp-for="UpdateDto.LocationId" class="form-select">
                                    <option value="">Select Location</option>
                                    @foreach (var location in Model.Locations)
                                    {
                                        <option value="@location.LocationId">@location.Name - @location.Campus</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.LocationId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DepartmentId" class="form-label"></label>
                                <select asp-for="UpdateDto.DepartmentId" class="form-select">
                                    <option value="">Select Department</option>
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department.DepartmentId">@department.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.DepartmentId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Status and Condition Selection -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Status" class="form-label"></label>
                                <select asp-for="UpdateDto.Status" class="form-select">
                                    <option value="Available">Available</option>
                                    <option value="In Use">In Use</option>
                                    <option value="Under Maintenance">Under Maintenance</option>
                                    <option value="Retired">Retired</option>
                                    <option value="Lost">Lost</option>
                                </select>
                                <span asp-validation-for="UpdateDto.Status" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Condition" class="form-label"></label>
                                <select asp-for="UpdateDto.Condition" class="form-select">
                                    <option value="New">New</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                    <option value="Broken">Broken</option>
                                </select>
                                <span asp-validation-for="UpdateDto.Condition" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Purchase and Serial Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.PurchaseDate" class="form-label"></label>
                                <input asp-for="UpdateDto.PurchaseDate" type="date" class="form-control" />
                                <span asp-validation-for="UpdateDto.PurchaseDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.SerialNumber" class="form-label"></label>
                                <input asp-for="UpdateDto.SerialNumber" class="form-control" />
                                <span asp-validation-for="UpdateDto.SerialNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Financial Information -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.PurchasePrice" class="form-label"></label>
                                <input asp-for="UpdateDto.PurchasePrice" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.PurchasePrice" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.CurrentValue" class="form-label"></label>
                                <input asp-for="UpdateDto.CurrentValue" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.CurrentValue" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Quantity" class="form-label"></label>
                                <input asp-for="UpdateDto.Quantity" type="number" class="form-control" />
                                <span asp-validation-for="UpdateDto.Quantity" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Financial Information Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Financial Information</h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.CostPerUnit" class="form-label"></label>
                                <input asp-for="UpdateDto.CostPerUnit" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.CostPerUnit" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.TotalCost" class="form-label"></label>
                                <input asp-for="UpdateDto.TotalCost" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.TotalCost" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DepreciationRate" class="form-label"></label>
                                <input asp-for="UpdateDto.DepreciationRate" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.DepreciationRate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.AccumulatedDepreciation" class="form-label"></label>
                                <input asp-for="UpdateDto.AccumulatedDepreciation" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.AccumulatedDepreciation" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.NetBookValue" class="form-label"></label>
                                <input asp-for="UpdateDto.NetBookValue" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.NetBookValue" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.UsefulLifeYears" class="form-label"></label>
                                <input asp-for="UpdateDto.UsefulLifeYears" type="number" class="form-control" />
                                <span asp-validation-for="UpdateDto.UsefulLifeYears" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Additional Information</h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.VendorName" class="form-label"></label>
                                <input asp-for="UpdateDto.VendorName" class="form-control" />
                                <span asp-validation-for="UpdateDto.VendorName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.InvoiceNumber" class="form-label"></label>
                                <input asp-for="UpdateDto.InvoiceNumber" class="form-control" />
                                <span asp-validation-for="UpdateDto.InvoiceNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.WarrantyExpiry" class="form-label"></label>
                                <input asp-for="UpdateDto.WarrantyExpiry" type="date" class="form-control" />
                                <span asp-validation-for="UpdateDto.WarrantyExpiry" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DisposalDate" class="form-label"></label>
                                <input asp-for="UpdateDto.DisposalDate" type="date" class="form-control" />
                                <span asp-validation-for="UpdateDto.DisposalDate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DisposalValue" class="form-label"></label>
                                <input asp-for="UpdateDto.DisposalValue" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="UpdateDto.DisposalValue" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Remarks" class="form-label"></label>
                                <textarea asp-for="UpdateDto.Remarks" class="form-control" rows="2"></textarea>
                                <span asp-validation-for="UpdateDto.Remarks" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">Update Asset</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this asset? This action cannot be undone.</p>
                <form method="post" asp-page-handler="Delete">
                    <input type="hidden" name="id" id="deleteId" />
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Performance-optimized search and filter functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
            restoreFilterState();

            // Initialize Bootstrap modals
            initializeModals();
        });

        function initializeFilters() {
            const searchInput = document.getElementById('searchInput');
            const filterForm = document.getElementById('filterForm');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const assetsTable = document.querySelector('.table-responsive');

            // Debounced search with loading indicator
            if (searchInput) {
                const debouncedSearch = debounce(function() {
                    showLoading();
                    filterForm.submit();
                }, 600);

                searchInput.addEventListener('input', debouncedSearch);
            }

            // Store filter state before submission
            filterForm.addEventListener('submit', function() {
                saveFilterState();
            });
        }

        function initializeModals() {
            // Edit Modal - Populate form with asset data
            var editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;

                    // Set basic fields
                    document.getElementById('UpdateDto_AssetId').value = button.getAttribute('data-id');
                    document.getElementById('UpdateDto_AssetTag').value = button.getAttribute('data-assettag') || '';
                    document.getElementById('UpdateDto_Name').value = button.getAttribute('data-name') || '';
                    document.getElementById('UpdateDto_Description').value = button.getAttribute('data-desc') || '';
                    document.getElementById('UpdateDto_CategoryId').value = button.getAttribute('data-categoryid') || '';
                    document.getElementById('UpdateDto_LocationId').value = button.getAttribute('data-locationid') || '';
                    document.getElementById('UpdateDto_DepartmentId').value = button.getAttribute('data-departmentid') || '';
                    document.getElementById('UpdateDto_PurchaseDate').value = button.getAttribute('data-purchasedate') || '';
                    document.getElementById('UpdateDto_PurchasePrice').value = button.getAttribute('data-purchaseprice') || '';
                    document.getElementById('UpdateDto_CurrentValue').value = button.getAttribute('data-currentvalue') || '';
                    document.getElementById('UpdateDto_Status').value = button.getAttribute('data-status') || '';
                    document.getElementById('UpdateDto_SerialNumber').value = button.getAttribute('data-serialnumber') || '';
                    document.getElementById('UpdateDto_Condition').value = button.getAttribute('data-condition') || '';
                    document.getElementById('UpdateDto_Quantity').value = button.getAttribute('data-quantity') || '1';

                    // Set financial fields
                    document.getElementById('UpdateDto_CostPerUnit').value = button.getAttribute('data-costperunit') || '';
                    document.getElementById('UpdateDto_TotalCost').value = button.getAttribute('data-totalcost') || '';
                    document.getElementById('UpdateDto_DepreciationRate').value = button.getAttribute('data-depreciationrate') || '';
                    document.getElementById('UpdateDto_AccumulatedDepreciation').value = button.getAttribute('data-accumulateddepreciation') || '';
                    document.getElementById('UpdateDto_NetBookValue').value = button.getAttribute('data-netbookvalue') || '';
                    document.getElementById('UpdateDto_UsefulLifeYears').value = button.getAttribute('data-usefullifeyears') || '';

                    // Set additional fields
                    document.getElementById('UpdateDto_VendorName').value = button.getAttribute('data-vendorname') || '';
                    document.getElementById('UpdateDto_InvoiceNumber').value = button.getAttribute('data-invoicenumber') || '';
                    document.getElementById('UpdateDto_WarrantyExpiry').value = button.getAttribute('data-warrantyexpiry') || '';
                    document.getElementById('UpdateDto_DisposalDate').value = button.getAttribute('data-disposaldate') || '';
                    document.getElementById('UpdateDto_DisposalValue').value = button.getAttribute('data-disposalvalue') || '';
                    document.getElementById('UpdateDto_Remarks').value = button.getAttribute('data-remarks') || '';
                });
            }

            // Delete Modal - Set asset ID for deletion
            var deleteModal = document.getElementById('deleteModal');
            if (deleteModal) {
                deleteModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var id = button.getAttribute('data-id');
                    document.getElementById('deleteId').value = id;
                });
            }

            // Show specific modal if ActiveModal is set (for validation errors)
            @if (!string.IsNullOrEmpty(Model.ActiveModal))
            {
                    <text>
                    var modalElement = document.getElementById('@(Model.ActiveModal)Modal');
                    if (modalElement) {
                        var modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    }
                    </text>
            }
        }

        function submitFilterForm() {
            showLoading();
            document.getElementById('filterForm').submit();
        }

        function showLoading() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const assetsTable = document.querySelector('.table-responsive');

            if (loadingIndicator && assetsTable) {
                loadingIndicator.classList.remove('d-none');
                assetsTable.style.opacity = '0.5';
            }
        }

        function removeFilter(filterName) {
            const url = new URL(window.location.href);
            url.searchParams.delete(filterName);
            window.location.href = url.toString();
        }

        function clearAllFilters() {
            const url = new URL(window.location.href);
            // Remove all filter parameters
            ['SearchTerm', 'StatusFilter', 'ConditionFilter', 'CategoryFilter', 'LocationFilter', 'DepartmentFilter']
                .forEach(param => url.searchParams.delete(param));
            window.location.href = url.toString();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            submitFilterForm();
        }

        // Save and restore filter state
        function saveFilterState() {
            const filters = {
                searchTerm: document.getElementById('searchInput')?.value,
                status: document.getElementById('statusFilter')?.value,
                condition: document.getElementById('conditionFilter')?.value,
                category: document.getElementById('categoryFilter')?.value,
                location: document.getElementById('locationFilter')?.value,
                department: document.getElementById('departmentFilter')?.value
            };
            sessionStorage.setItem('assetFilters', JSON.stringify(filters));
        }

        function restoreFilterState() {
            try {
                const saved = sessionStorage.getItem('assetFilters');
                if (saved) {
                    const filters = JSON.parse(saved);

                    // Only restore if no current filters in URL
                    const urlParams = new URLSearchParams(window.location.search);
                    if (!urlParams.toString()) {
                        if (filters.searchTerm) document.getElementById('searchInput').value = filters.searchTerm;
                        if (filters.status) document.getElementById('statusFilter').value = filters.status;
                        if (filters.condition) document.getElementById('conditionFilter').value = filters.condition;
                        if (filters.category) document.getElementById('categoryFilter').value = filters.category;
                        if (filters.location) document.getElementById('locationFilter').value = filters.location;
                        if (filters.department) document.getElementById('departmentFilter').value = filters.department;
                    }
                }
            } catch (e) {
                console.warn('Could not restore filter state:', e);
            }
        }

        // Enhanced debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Enhanced export with current filters
        function exportToCsv() {
            const currentParams = new URLSearchParams(window.location.search);
            currentParams.set('format', 'csv');
            currentParams.set('handler', 'export');
            window.location.href = `?${currentParams.toString()}`;
        }

        function exportToExcel() {
            const currentParams = new URLSearchParams(window.location.search);
            currentParams.set('format', 'excel');
            currentParams.set('handler', 'export');
            window.location.href = `?${currentParams.toString()}`;
        }
    </script>
}