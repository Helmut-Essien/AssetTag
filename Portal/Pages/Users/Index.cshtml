@page
@model Portal.Pages.Users.IndexModel
@{
    ViewData["Title"] = "User Management";
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Users (@Model.TotalCount Total)</h1>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#manageRolesModal">Manage Roles</button>
    </div>

    <form method="get" class="mb-3">
        <div class="row">
            <div class="col-md-4">
                <input asp-for="Search" class="form-control" placeholder="Search by name or email" />
            </div>
            <div class="col-md-3">
                <select asp-for="DepartmentId" class="form-select">
                    <option value="">All Departments</option>
                    @foreach (var dept in Model.Departments.Skip(1))
                    {
                        <option value="@dept.Value">@dept.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <select asp-for="IsActive" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-info">@Model.Message</div>
    }

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Job Role</th>
                    <th>Department</th>
                    <th>Active</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model.Users)
                {
                    <tr>
                        <td>@user.FirstName @user.Surname</td>
                        <td>@user.Email</td>
                        <td>@user.JobRole</td>
                        <td>@Model.Departments.FirstOrDefault(d => d.Value == user.DepartmentId)?.Text</td>
                        <td>
                            <span class="badge @(user.IsActive ? "bg-success" : "bg-danger")">
                                @(user.IsActive ? "Yes" : "No")
                            </span>
                        </td>
                        <td>@user.DateCreated.ToShortDateString()</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editModal"
                                    data-id="@user.Id"
                                    data-firstname="@user.FirstName"
                                    data-surname="@user.Surname"
                                    data-othernames="@user.OtherNames"
                                    data-dateofbirth="@(user.DateOfBirth?.ToString("yyyy-MM-dd"))"
                                    data-address="@user.Address"
                                    data-jobrole="@user.JobRole"
                                    data-profileimage="@user.ProfileImage"
                                    data-isactive="@user.IsActive.ToString().ToLower()"
                                    data-departmentid="@user.DepartmentId">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn @(user.IsActive ? "btn-warning" : "btn-success") btn-sm me-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#@(user.IsActive ? "deactivateModal" : "activateModal")"
                                    data-id="@user.Id">
                                <i class="bi bi-power"></i> @(user.IsActive ? "Deactivate" : "Activate")
                            </button>
                            <button class="btn btn-info btn-sm me-1 roles-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rolesModal"
                                    data-userid="@user.Id"
                                    data-username="@user.FirstName @user.Surname">
                                <i class="bi bi-key"></i> Roles
                            </button>
                            <button class="btn btn-secondary btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#resetModal"
                                    data-id="@user.Id">
                                <i class="bi bi-lock"></i> Reset PW
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Pagination">
        <ul class="pagination justify-content-center">
            @if (Model.CurrentPage > 1)
            {
                <li class="page-item">
                    <a class="page-link" asp-page="./Index" asp-route-page="@(Model.CurrentPage - 1)" asp-route-search="@Model.Search" asp-route-departmentId="@Model.DepartmentId" asp-route-isActive="@Model.IsActive">Previous</a>
                </li>
            }
            <li class="page-item disabled"><a class="page-link">Page @Model.CurrentPage of @Math.Ceiling((double)Model.TotalCount / Model.PageSize)</a></li>
            @if (Model.CurrentPage < Math.Ceiling((double)Model.TotalCount / Model.PageSize))
            {
                <li class="page-item">
                    <a class="page-link" asp-page="./Index" asp-route-page="@(Model.CurrentPage + 1)" asp-route-search="@Model.Search" asp-route-departmentId="@Model.DepartmentId" asp-route-isActive="@Model.IsActive">Next</a>
                </li>
            }
        </ul>
    </nav>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="editUserForm">
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                    <input type="hidden" id="editUserId" name="id" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editFirstName" class="form-label">First Name</label>
                                <input type="text" id="editFirstName" name="firstName" class="form-control" />
                                <span class="text-danger" id="editFirstNameValidation"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSurname" class="form-label">Surname</label>
                                <input type="text" id="editSurname" name="surname" class="form-control" />
                                <span class="text-danger" id="editSurnameValidation"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editOtherNames" class="form-label">Other Names</label>
                                <input type="text" id="editOtherNames" name="otherNames" class="form-control" />
                                <span class="text-danger" id="editOtherNamesValidation"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDateOfBirth" class="form-label">Date of Birth</label>
                                <input type="date" id="editDateOfBirth" name="dateOfBirth" class="form-control" />
                                <span class="text-danger" id="editDateOfBirthValidation"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editAddress" class="form-label">Address</label>
                        <textarea id="editAddress" name="address" class="form-control" rows="3"></textarea>
                        <span class="text-danger" id="editAddressValidation"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editJobRole" class="form-label">Job Role</label>
                                <input type="text" id="editJobRole" name="jobRole" class="form-control" />
                                <span class="text-danger" id="editJobRoleValidation"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editProfileImage" class="form-label">Profile Image URL</label>
                                <input type="text" id="editProfileImage" name="profileImage" class="form-control" />
                                <span class="text-danger" id="editProfileImageValidation"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editIsActive" class="form-label">Status</label>
                                <select id="editIsActive" name="isActive" class="form-select">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                                <span class="text-danger" id="editIsActiveValidation"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDepartmentId" class="form-label">Department</label>
                                <select id="editDepartmentId" name="departmentId" class="form-select">
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department.Value">@department.Text</option>
                                    }
                                </select>
                                <span class="text-danger" id="editDepartmentIdValidation"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Deactivate Modal -->
<div class="modal fade" id="deactivateModal" tabindex="-1" aria-labelledby="deactivateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deactivateModalLabel">Confirm Deactivation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to deactivate this user?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-page-handler="ToggleActivation" style="display: inline;">
                    <input type="hidden" name="id" id="deactivateId" />
                    <input type="hidden" name="isActive" value="false" />
                    <button type="submit" class="btn btn-danger">Deactivate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Activate Modal -->
<div class="modal fade" id="activateModal" tabindex="-1" aria-labelledby="activateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activateModalLabel">Confirm Activation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to activate this user?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-page-handler="ToggleActivation" style="display: inline;">
                    <input type="hidden" name="id" id="activateId" />
                    <input type="hidden" name="isActive" value="true" />
                    <button type="submit" class="btn btn-success">Activate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Roles Modal -->
<div class="modal fade" id="rolesModal" tabindex="-1" aria-labelledby="rolesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rolesModalLabel">Manage Roles for <span id="rolesUserName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="rolesModalMessage"></div>

                <h6>Current Roles:</h6>
                <ul class="list-group mb-3" id="currentRolesList">
                    <!-- Roles will be populated via JavaScript -->
                </ul>

                <h6>Add New Role:</h6>
                <form id="addRoleForm">
                    <input type="hidden" id="rolesUserId" name="id" />
                    <div class="input-group mb-3">
                        <select id="newRoleName" name="roleName" class="form-select" required>
                            <option value="">Select a role...</option>
                        </select>
                        <button type="submit" class="btn btn-success">Add Role</button>
                    </div>
                    <span id="roleNameValidation" class="text-danger"></span>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Roles Modal -->
<div class="modal fade" id="manageRolesModal" tabindex="-1" aria-labelledby="manageRolesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageRolesModalLabel">Manage System Roles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="manageRolesMessage"></div>

                <h6>Current Roles:</h6>
                <ul class="list-group mb-3" id="systemRolesList">
                    <!-- Roles will be populated via JavaScript -->
                </ul>

                <h6>Create New Role:</h6>
                <form id="createRoleForm">
                    <div class="input-group mb-3">
                        <input type="text" id="newSystemRoleName" name="roleName" class="form-control" placeholder="Role Name" required />
                        <button type="submit" class="btn btn-success">Create Role</button>
                    </div>
                    <span id="systemRoleNameValidation" class="text-danger"></span>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">Confirm Password Reset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reset the password for this user? A reset token will be generated.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-page-handler="ResetPassword" style="display: inline;">
                    <input type="hidden" name="id" id="resetId" />
                    <button type="submit" class="btn btn-warning">Reset Password</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Edit Modal
            var editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;

                    document.getElementById('UpdateDto_Id').value = button.getAttribute('data-id');
                    document.getElementById('UpdateDto_FirstName').value = button.getAttribute('data-firstname') || '';
                    document.getElementById('UpdateDto_Surname').value = button.getAttribute('data-surname') || '';
                    document.getElementById('UpdateDto_OtherNames').value = button.getAttribute('data-othernames') || '';
                    document.getElementById('UpdateDto_DateOfBirth').value = button.getAttribute('data-dateofbirth') || '';
                    document.getElementById('UpdateDto_Address').value = button.getAttribute('data-address') || '';
                    document.getElementById('UpdateDto_JobRole').value = button.getAttribute('data-jobrole') || '';
                    document.getElementById('UpdateDto_ProfileImage').value = button.getAttribute('data-profileimage') || '';
                    document.getElementById('UpdateDto_IsActive').value = button.getAttribute('data-isactive');
                    document.getElementById('UpdateDto_DepartmentId').value = button.getAttribute('data-departmentid') || '';
                });
            }

            // Deactivate Modal
            var deactivateModal = document.getElementById('deactivateModal');
            if (deactivateModal) {
                deactivateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('deactivateId').value = button.getAttribute('data-id');
                });
            }

            // Activate Modal
            var activateModal = document.getElementById('activateModal');
            if (activateModal) {
                activateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('activateId').value = button.getAttribute('data-id');
                });
            }

            // Reset Modal
            var resetModal = document.getElementById('resetModal');
            if (resetModal) {
                resetModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('resetId').value = button.getAttribute('data-id');
                });
            }

            // Roles Modal - Enhanced with AJAX
            var rolesModal = document.getElementById('rolesModal');
            if (rolesModal) {
                rolesModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var userId = button.getAttribute('data-userid');

                    // Set the user ID in the hidden field
                    document.getElementById('rolesUserId').value = userId;

                    // Clear previous roles and message
                    document.getElementById('currentRolesList').innerHTML = '';
                    document.getElementById('rolesModalMessage').innerHTML = '';
                    document.getElementById('newRoleName').innerHTML = '<option value="">Loading roles...</option>';
                    document.getElementById('roleNameValidation').textContent = '';

                    // Load user roles and available roles
                    loadUserRoles(userId);
                    loadAvailableRoles();
                });
            }

            // Manage Roles Modal
            var manageRolesModal = document.getElementById('manageRolesModal');
            if (manageRolesModal) {
                manageRolesModal.addEventListener('show.bs.modal', function (event) {
                    document.getElementById('manageRolesMessage').innerHTML = '';
                    document.getElementById('systemRoleNameValidation').textContent = '';
                    document.getElementById('newSystemRoleName').value = '';
                    
                    // Load all system roles
                    loadAllSystemRoles();
                });
            }

            // Add Role Form Submission
            var addRoleForm = document.getElementById('addRoleForm');
            if (addRoleForm) {
                addRoleForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    var userId = document.getElementById('rolesUserId').value;
                    var roleName = document.getElementById('newRoleName').value;

                    if (!roleName.trim()) {
                        document.getElementById('roleNameValidation').textContent = 'Please select a role.';
                        return;
                    }

                    addUserRole(userId, roleName);
                });
            }

            // Create Role Form Submission
            var createRoleForm = document.getElementById('createRoleForm');
            if (createRoleForm) {
                createRoleForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    var roleName = document.getElementById('newSystemRoleName').value.trim();

                    if (!roleName) {
                        document.getElementById('systemRoleNameValidation').textContent = 'Role name is required.';
                        return;
                    }

                    createSystemRole(roleName);
                });
            }

            // ========== ROLE MANAGEMENT FUNCTIONS ==========

            // Function to load user roles via AJAX
            function loadUserRoles(userId) {
                fetch(`?handler=RolesData&id=${userId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        displayUserRoles(data.roles, data.userId);
                    })
                    .catch(error => {
                        console.error('Error loading user roles:', error);
                        showRolesMessage('Error loading user roles. Please try again.', 'danger');
                    });
            }

            // Function to load available roles for dropdown
            function loadAvailableRoles() {
                fetch('?handler=AllRolesData')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(roles => {
                        populateRolesDropdown(roles);
                    })
                    .catch(error => {
                        console.error('Error loading available roles:', error);
                        document.getElementById('newRoleName').innerHTML = '<option value="">Error loading roles</option>';
                    });
            }

            // Function to load all system roles for management
            function loadAllSystemRoles() {
                fetch('?handler=AllRolesData')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(roles => {
                        displaySystemRoles(roles);
                    })
                    .catch(error => {
                        console.error('Error loading system roles:', error);
                        showManageRolesMessage('Error loading system roles. Please try again.', 'danger');
                    });
            }

            // Function to display user roles
            function displayUserRoles(roles, userId) {
                var rolesList = document.getElementById('currentRolesList');
                rolesList.innerHTML = '';

                if (roles && roles.length > 0) {
                    roles.forEach(function(role) {
                        var listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            ${role}
                            <button type="button" class="btn btn-danger btn-sm remove-role-btn"
                                    data-userid="${userId}" data-rolename="${role}">
                                Remove
                            </button>
                        `;
                        rolesList.appendChild(listItem);
                    });

                    // Add event listeners to remove buttons
                    document.querySelectorAll('.remove-role-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            var userId = this.getAttribute('data-userid');
                            var roleName = this.getAttribute('data-rolename');
                            removeUserRole(userId, roleName);
                        });
                    });
                } else {
                    rolesList.innerHTML = '<li class="list-group-item text-muted">No roles assigned.</li>';
                }
            }

            // Function to populate roles dropdown
            function populateRolesDropdown(roles) {
                var select = document.getElementById('newRoleName');
                select.innerHTML = '<option value="">Select a role...</option>';
                
                if (roles && roles.length > 0) {
                    roles.forEach(role => {
                        var option = document.createElement('option');
                        option.value = role;
                        option.textContent = role;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No roles available</option>';
                }
            }

            // Function to display system roles in management modal
            function displaySystemRoles(roles) {
                var rolesList = document.getElementById('systemRolesList');
                rolesList.innerHTML = '';

                if (roles && roles.length > 0) {
                    roles.forEach(function(role) {
                        var listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            ${role}
                            <button type="button" class="btn btn-danger btn-sm delete-system-role-btn"
                                    data-rolename="${role}">
                                Delete
                            </button>
                        `;
                        rolesList.appendChild(listItem);
                    });

                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-system-role-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            var roleName = this.getAttribute('data-rolename');
                            if (confirm(`Are you sure you want to delete the role "${roleName}"?`)) {
                                deleteSystemRole(roleName);
                            }
                        });
                    });
                } else {
                    rolesList.innerHTML = '<li class="list-group-item text-muted">No roles in system.</li>';
                }
            }

            // Function to add role to user via AJAX
            function addUserRole(userId, roleName) {
                var formData = new FormData();
                formData.append('id', userId);
                formData.append('roleName', roleName);

                fetch('?handler=AddRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Reload the roles list and refresh dropdown
                    loadUserRoles(userId);
                    loadAvailableRoles();
                    document.getElementById('newRoleName').value = '';
                    document.getElementById('roleNameValidation').textContent = '';
                    
                    showRolesMessage('Role added successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error adding role:', error);
                    showRolesMessage('Error adding role. Please try again.', 'danger');
                });
            }

            // Function to remove role from user via AJAX
            function removeUserRole(userId, roleName) {
                var formData = new FormData();
                formData.append('id', userId);
                formData.append('roleName', roleName);

                fetch('?handler=RemoveRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Reload the roles list and refresh dropdown
                    loadUserRoles(userId);
                    loadAvailableRoles();
                    
                    showRolesMessage('Role removed successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error removing role:', error);
                    showRolesMessage('Error removing role. Please try again.', 'danger');
                });
            }

            // Function to create system role via AJAX
            function createSystemRole(roleName) {
                var formData = new FormData();
                formData.append('roleName', roleName);

                fetch('?handler=CreateRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Refresh system roles list and clear form
                    loadAllSystemRoles();
                    document.getElementById('newSystemRoleName').value = '';
                    document.getElementById('systemRoleNameValidation').textContent = '';
                    
                    showManageRolesMessage('Role created successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error creating role:', error);
                    showManageRolesMessage('Error creating role. Please try again.', 'danger');
                });
            }

            // Function to delete system role via AJAX
            function deleteSystemRole(roleName) {
                var formData = new FormData();
                formData.append('roleName', roleName);

                fetch('?handler=DeleteRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Refresh system roles list
                    loadAllSystemRoles();
                    
                    showManageRolesMessage('Role deleted successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error deleting role:', error);
                    showManageRolesMessage('Error deleting role. Please try again.', 'danger');
                });
            }

            // Helper functions for showing messages
            function showRolesMessage(message, type) {
                var messageDiv = document.getElementById('rolesModalMessage');
                messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }

            function showManageRolesMessage(message, type) {
                var messageDiv = document.getElementById('manageRolesMessage');
                messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }
        });
    </script>
}



   @*  <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Edit Modal
            var editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;

                    document.getElementById('editUserId').value = button.getAttribute('data-id');
                    document.getElementById('editFirstName').value = button.getAttribute('data-firstname') || '';
                    document.getElementById('editSurname').value = button.getAttribute('data-surname') || '';
                    document.getElementById('editOtherNames').value = button.getAttribute('data-othernames') || '';
                    document.getElementById('editDateOfBirth').value = button.getAttribute('data-dateofbirth') || '';
                    document.getElementById('editAddress').value = button.getAttribute('data-address') || '';
                    document.getElementById('editJobRole').value = button.getAttribute('data-jobrole') || '';
                    document.getElementById('editProfileImage').value = button.getAttribute('data-profileimage') || '';
                    document.getElementById('editIsActive').value = button.getAttribute('data-isactive');
                    document.getElementById('editDepartmentId').value = button.getAttribute('data-departmentid') || '';

                    // Clear validation messages
                    clearValidationMessages();
                });
            }

            // Edit Form Submission
            var editUserForm = document.getElementById('editUserForm');
            if (editUserForm) {
                editUserForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    updateUser();
                });
            }

            // Deactivate Modal
            var deactivateModal = document.getElementById('deactivateModal');
            if (deactivateModal) {
                deactivateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('deactivateId').value = button.getAttribute('data-id');
                });
            }

            // Activate Modal
            var activateModal = document.getElementById('activateModal');
            if (activateModal) {
                activateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('activateId').value = button.getAttribute('data-id');
                });
            }

            // Reset Modal
            var resetModal = document.getElementById('resetModal');
            if (resetModal) {
                resetModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('resetId').value = button.getAttribute('data-id');
                });
            }

            // Roles Modal
            var rolesModal = document.getElementById('rolesModal');
            if (rolesModal) {
                rolesModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var userId = button.getAttribute('data-userid');
                    var userName = button.getAttribute('data-username');

                    document.getElementById('rolesUserName').textContent = userName;
                    document.getElementById('rolesUserId').value = userId;
                    document.getElementById('currentRolesList').innerHTML = '';
                    document.getElementById('rolesModalMessage').innerHTML = '';
                    document.getElementById('roleNameValidation').textContent = '';

                    loadUserRoles(userId);
                    loadAllRolesForDropdown(userId);
                });
            }

            // Add Role Form
            var addRoleForm = document.getElementById('addRoleForm');
            if (addRoleForm) {
                addRoleForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    var userId = document.getElementById('rolesUserId').value;
                    var roleName = document.getElementById('newRoleName').value;

                    if (!roleName) {
                        document.getElementById('roleNameValidation').textContent = 'Please select a role.';
                        return;
                    }

                    addUserRole(userId, roleName);
                });
            }

            // Manage Roles Modal
            var manageRolesModal = document.getElementById('manageRolesModal');
            if (manageRolesModal) {
                manageRolesModal.addEventListener('show.bs.modal', function (event) {
                    document.getElementById('manageRolesMessage').innerHTML = '';
                    document.getElementById('systemRoleNameValidation').textContent = '';
                    loadAllSystemRoles();
                });
            }

            // Create Role Form
            var createRoleForm = document.getElementById('createRoleForm');
            if (createRoleForm) {
                createRoleForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    var roleName = document.getElementById('newSystemRoleName').value.trim();

                    if (!roleName) {
                        document.getElementById('systemRoleNameValidation').textContent = 'Role name is required.';
                        return;
                    }

                    createSystemRole(roleName);
                });
            }

            // Function to update user via AJAX
            function updateUser() {
                var formData = new FormData();
                formData.append('id', document.getElementById('editUserId').value);
                formData.append('firstName', document.getElementById('editFirstName').value);
                formData.append('surname', document.getElementById('editSurname').value);
                formData.append('otherNames', document.getElementById('editOtherNames').value);
                formData.append('dateOfBirth', document.getElementById('editDateOfBirth').value);
                formData.append('address', document.getElementById('editAddress').value);
                formData.append('jobRole', document.getElementById('editJobRole').value);
                formData.append('profileImage', document.getElementById('editProfileImage').value);
                formData.append('isActive', document.getElementById('editIsActive').value);
                formData.append('departmentId', document.getElementById('editDepartmentId').value);

                fetch('?handler=Update', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        return response.text();
                    }
                })
                .then(() => {
                    // If not redirected, close the modal and refresh
                    var editModalInstance = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                    editModalInstance.hide();
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error updating user:', error);
                    alert('Error updating user. Please try again.');
                });
            }

            // Function to clear validation messages
            function clearValidationMessages() {
                var validationSpans = document.querySelectorAll('[id$="Validation"]');
                validationSpans.forEach(span => {
                    span.textContent = '';
                });
            }

            // ... rest of your JavaScript functions (loadUserRoles, loadAllRolesForDropdown, etc.)
            // Keep all the other JavaScript functions you had for roles management
            // They should work fine with the updated HTML structure
        });
    </script> *@
}