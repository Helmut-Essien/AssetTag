@* @page
@model Portal.Pages.Users.IndexModel
@{
    ViewData["Title"] = "User Management";
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Users (@Model.TotalCount Total)</h1>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#inviteUsersModal">
                <i class="bi bi-person-plus"></i> Invite Users
            </button>
            <button class="btn btn-secondary me-2" data-bs-toggle="modal" data-bs-target="#manageRolesModal">Manage Roles</button>
        </div>
    </div>

    <form method="get" class="mb-3">
        <div class="row">
            <div class="col-md-4">
                <input asp-for="Search" class="form-control" placeholder="Search by name or email" />
            </div>
            <div class="col-md-3">
                <select asp-for="DepartmentId" class="form-select">
                    <option value="">All Departments</option>
                    @foreach (var dept in Model.Departments.Skip(1))
                    {
                        <option value="@dept.Value">@dept.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <select asp-for="IsActive" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-info">@Model.Message</div>
    }

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Job Role</th>
                    <th>Department</th>
                    <th>Active</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model.Users)
                {
                    <tr>
                        <td>@user.FirstName @user.Surname</td>
                        <td>@user.Email</td>
                        <td>@user.JobRole</td>
                        <td>@Model.Departments.FirstOrDefault(d => d.Value == user.DepartmentId)?.Text</td>
                        <td>
                            <span class="badge @(user.IsActive ? "bg-success" : "bg-danger")">
                                @(user.IsActive ? "Yes" : "No")
                            </span>
                        </td>
                        <td>@user.DateCreated.ToShortDateString()</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editModal"
                                    data-id="@user.Id"
                                    data-firstname="@user.FirstName"
                                    data-surname="@user.Surname"
                                    data-othernames="@user.OtherNames"
                                    data-dateofbirth="@(user.DateOfBirth?.ToString("yyyy-MM-dd"))"
                                    data-address="@user.Address"
                                    data-jobrole="@user.JobRole"
                                    data-profileimage="@user.ProfileImage"
                                    data-isactive="@user.IsActive.ToString().ToLower()"
                                    data-departmentid="@user.DepartmentId">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn @(user.IsActive ? "btn-warning" : "btn-success") btn-sm me-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#@(user.IsActive ? "deactivateModal" : "activateModal")"
                                    data-id="@user.Id">
                                <i class="bi bi-power"></i> @(user.IsActive ? "Deactivate" : "Activate")
                            </button>
                            <button class="btn btn-info btn-sm me-1 roles-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rolesModal"
                                    data-userid="@user.Id"
                                    data-username="@user.FirstName @user.Surname">
                                <i class="bi bi-key"></i> Roles
                            </button>
                            <button class="btn btn-secondary btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#resetModal"
                                    data-id="@user.Id">
                                <i class="bi bi-lock"></i> Reset PW
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Pagination">
        <ul class="pagination justify-content-center">
            @if (Model.CurrentPage > 1)
            {
                <li class="page-item">
                    <a class="page-link" asp-page="./Index" asp-route-page="@(Model.CurrentPage - 1)" asp-route-search="@Model.Search" asp-route-departmentId="@Model.DepartmentId" asp-route-isActive="@Model.IsActive">Previous</a>
                </li>
            }
            <li class="page-item disabled"><a class="page-link">Page @Model.CurrentPage of @Math.Ceiling((double)Model.TotalCount / Model.PageSize)</a></li>
            @if (Model.CurrentPage < Math.Ceiling((double)Model.TotalCount / Model.PageSize))
            {
                <li class="page-item">
                    <a class="page-link" asp-page="./Index" asp-route-page="@(Model.CurrentPage + 1)" asp-route-search="@Model.Search" asp-route-departmentId="@Model.DepartmentId" asp-route-isActive="@Model.IsActive">Next</a>
                </li>
            }
        </ul>
    </nav>
</div>

<!-- Edit Modal -->
<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="Update" id="editUserForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                    <input type="hidden" id="editUserId" asp-for="UpdateDto.Id" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.FirstName" class="form-label">First Name</label>
                                <input type="text" id="editFirstName" asp-for="UpdateDto.FirstName" class="form-control" />
                                <span asp-validation-for="UpdateDto.FirstName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Surname" class="form-label">Surname</label>
                                <input type="text" id="editSurname" asp-for="UpdateDto.Surname" class="form-control" />
                                <span asp-validation-for="UpdateDto.Surname" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.OtherNames" class="form-label">Other Names</label>
                                <input type="text" id="editOtherNames" asp-for="UpdateDto.OtherNames" class="form-control" />
                                <span asp-validation-for="UpdateDto.OtherNames" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DateOfBirth" class="form-label">Date of Birth</label>
                                <input type="date" id="editDateOfBirth" asp-for="UpdateDto.DateOfBirth" class="form-control" />
                                <span asp-validation-for="UpdateDto.DateOfBirth" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="UpdateDto.Address" class="form-label">Address</label>
                        <textarea id="editAddress" asp-for="UpdateDto.Address" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="UpdateDto.Address" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.JobRole" class="form-label">Job Role</label>
                                <input type="text" id="editJobRole" asp-for="UpdateDto.JobRole" class="form-control" />
                                <span asp-validation-for="UpdateDto.JobRole" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.ProfileImage" class="form-label">Profile Image URL</label>
                                <input type="text" id="editProfileImage" asp-for="UpdateDto.ProfileImage" class="form-control" />
                                <span asp-validation-for="UpdateDto.ProfileImage" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.IsActive" class="form-label">Status</label>
                                <select id="editIsActive" asp-for="UpdateDto.IsActive" class="form-select">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                                <span asp-validation-for="UpdateDto.IsActive" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DepartmentId" class="form-label">Department</label>
                                <select id="editDepartmentId" asp-for="UpdateDto.DepartmentId" class="form-select">
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department.Value">@department.Text</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.DepartmentId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Deactivate Modal -->
<div class="modal fade" id="deactivateModal" tabindex="-1" aria-labelledby="deactivateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deactivateModalLabel">Confirm Deactivation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to deactivate this user?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-page-handler="ToggleActivation" style="display: inline;">
                    <input type="hidden" name="id" id="deactivateId" />
                    <input type="hidden" name="isActive" value="false" />
                    <button type="submit" class="btn btn-danger">Deactivate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Activate Modal -->
<div class="modal fade" id="activateModal" tabindex="-1" aria-labelledby="activateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activateModalLabel">Confirm Activation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to activate this user?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-page-handler="ToggleActivation" style="display: inline;">
                    <input type="hidden" name="id" id="activateId" />
                    <input type="hidden" name="isActive" value="true" />
                    <button type="submit" class="btn btn-success">Activate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Roles Modal -->
<div class="modal fade" id="rolesModal" tabindex="-1" aria-labelledby="rolesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rolesModalLabel">Manage Roles for <span id="rolesUserName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="rolesModalMessage"></div>

                <h6>Current Roles:</h6>
                <ul class="list-group mb-3" id="currentRolesList">
                    <!-- Roles will be populated via JavaScript -->
                </ul>

                <h6>Add New Role:</h6>
                <form id="addRoleForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="rolesUserId" name="id" />
                    <div class="input-group mb-3">
                        <select id="newRoleName" name="roleName" class="form-select" required>
                            <option value="">Select a role...</option>
                        </select>
                        <button type="submit" class="btn btn-success">Add Role</button>
                    </div>
                    <span id="roleNameValidation" class="text-danger"></span>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Roles Modal -->
<div class="modal fade" id="manageRolesModal" tabindex="-1" aria-labelledby="manageRolesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageRolesModalLabel">Manage System Roles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="manageRolesMessage"></div>

                <h6>Current Roles:</h6>
                <ul class="list-group mb-3" id="systemRolesList">
                    <!-- Roles will be populated via JavaScript -->
                </ul>

                <h6>Create New Role:</h6>
                <form id="createRoleForm">
                    @Html.AntiForgeryToken()
                    <div class="input-group mb-3">
                        <input type="text" id="newSystemRoleName" name="roleName" class="form-control" placeholder="Role Name" required />
                        <button type="submit" class="btn btn-success">Create Role</button>
                    </div>
                    <span id="systemRoleNameValidation" class="text-danger"></span>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add the Invite Users Modal -->
<div class="modal fade" id="inviteUsersModal" tabindex="-1" aria-labelledby="inviteUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteUsersModalLabel">Invite Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="SendInvitations">
                <div class="modal-body">
                    <div class="mb-3">
                        <label asp-for="InviteEmails" class="form-label">Email Addresses</label>
                        <textarea asp-for="InviteEmails" class="form-control" rows="5" 
                                  placeholder="Enter email addresses, one per line or separated by commas"></textarea>
                        <span asp-validation-for="InviteEmails" class="text-danger"></span>
                        <div class="form-text">Enter multiple email addresses separated by commas, semicolons, or new lines.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="InviteRole" class="form-label">Role</label>
                        <select asp-for="InviteRole" class="form-select">
                            @foreach (var role in Model.AvailableRoles)
                            {
                                <option value="@role">@role</option>
                            }
                        </select>
                        <span asp-validation-for="InviteRole" class="text-danger"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        Send Invitations
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Invitations List Section -->
@if (Model.Invitations.Any())
{
    <div class="mt-4">
        <h3>Pending Invitations</h3>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Expires</th>
                        <th>Invited By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var invitation in Model.Invitations)
                    {
                        <tr>
                            <td>@invitation.Email</td>
                            <td>@invitation.Role</td>
                            <td>
                                <span class="badge @(invitation.IsUsed ? "bg-success" : invitation.ExpiresAt < DateTime.UtcNow ? "bg-danger" : "bg-warning")">
                                    @(invitation.IsUsed ? "Used" : invitation.ExpiresAt < DateTime.UtcNow ? "Expired" : "Pending")
                                </span>
                            </td>
                            <td>@invitation.ExpiresAt.ToString("MMM dd, yyyy HH:mm")</td>
                            <td>@invitation.InvitedByUserName</td>
                            <td>
                                @if (!invitation.IsUsed && invitation.ExpiresAt > DateTime.UtcNow)
                                {
                                    <form method="post" asp-page-handler="ResendInvitation" style="display: inline;">
                                        <input type="hidden" name="id" value="@invitation.Id" />
                                        <button type="submit" class="btn btn-warning btn-sm me-1">Resend</button>
                                    </form>
                                }
                                <form method="post" asp-page-handler="DeleteInvitation" style="display: inline;">
                                    <input type="hidden" name="id" value="@invitation.Id" />
                                    <button type="submit" class="btn btn-danger btn-sm" 
                                            onclick="return confirm('Are you sure you want to delete this invitation?')">Delete</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    }

<!-- Reset Password Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">Confirm Password Reset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reset the password for this user? A reset token will be generated.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-page-handler="ResetPassword" style="display: inline;">
                    <input type="hidden" name="id" id="resetId" />
                    <button type="submit" class="btn btn-warning">Reset Password</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
                    // Edit Modal
        var editModal = document.getElementById('editModal');
        if (editModal) {
            editModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;

                // Set the form fields with the data from the button's data-* attributes
                document.getElementById('editUserId').value = button.getAttribute('data-id');
                document.getElementById('editFirstName').value = button.getAttribute('data-firstname') || '';
                document.getElementById('editSurname').value = button.getAttribute('data-surname') || '';
                document.getElementById('editOtherNames').value = button.getAttribute('data-othernames') || '';
                document.getElementById('editDateOfBirth').value = button.getAttribute('data-dateofbirth') || '';
                document.getElementById('editAddress').value = button.getAttribute('data-address') || '';
                document.getElementById('editJobRole').value = button.getAttribute('data-jobrole') || '';
                document.getElementById('editProfileImage').value = button.getAttribute('data-profileimage') || '';

                // For the select elements, set the value
                var isActiveValue = button.getAttribute('data-isactive');
                if (isActiveValue) {
                    document.getElementById('editIsActive').value = isActiveValue;
                }

                var departmentIdValue = button.getAttribute('data-departmentid');
                if (departmentIdValue) {
                    document.getElementById('editDepartmentId').value = departmentIdValue;
                }
            });
        }

            // Deactivate Modal
            var deactivateModal = document.getElementById('deactivateModal');
            if (deactivateModal) {
                deactivateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('deactivateId').value = button.getAttribute('data-id');
                });
            }

            // Activate Modal
            var activateModal = document.getElementById('activateModal');
            if (activateModal) {
                activateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('activateId').value = button.getAttribute('data-id');
                });
            }

            // Reset Modal
            var resetModal = document.getElementById('resetModal');
            if (resetModal) {
                resetModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('resetId').value = button.getAttribute('data-id');
                });
            }

            // Roles Modal - Enhanced with AJAX
            var rolesModal = document.getElementById('rolesModal');
            if (rolesModal) {
                rolesModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var userId = button.getAttribute('data-userid');

                    // Set the user ID in the hidden field
                    document.getElementById('rolesUserId').value = userId;

                    // Clear previous roles and message
                    document.getElementById('currentRolesList').innerHTML = '';
                    document.getElementById('rolesModalMessage').innerHTML = '';
                    document.getElementById('newRoleName').innerHTML = '<option value="">Loading roles...</option>';
                    document.getElementById('roleNameValidation').textContent = '';

                    // Load user roles and available roles
                    loadUserRoles(userId);
                    loadAvailableRoles();
                });
            }

            // Manage Roles Modal
            var manageRolesModal = document.getElementById('manageRolesModal');
            if (manageRolesModal) {
                manageRolesModal.addEventListener('show.bs.modal', function (event) {
                    document.getElementById('manageRolesMessage').innerHTML = '';
                    document.getElementById('systemRoleNameValidation').textContent = '';
                    document.getElementById('newSystemRoleName').value = '';
                    
                    // Load all system roles
                    loadAllSystemRoles();
                });
            }

            // Add Role Form Submission
            var addRoleForm = document.getElementById('addRoleForm');
            if (addRoleForm) {
                addRoleForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    var userId = document.getElementById('rolesUserId').value;
                    var roleName = document.getElementById('newRoleName').value;

                    if (!roleName.trim()) {
                        document.getElementById('roleNameValidation').textContent = 'Please select a role.';
                        return;
                    }

                    addUserRole(userId, roleName);
                });
            }

            // Create Role Form Submission
            var createRoleForm = document.getElementById('createRoleForm');
            if (createRoleForm) {
                createRoleForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    var roleName = document.getElementById('newSystemRoleName').value.trim();

                    if (!roleName) {
                        document.getElementById('systemRoleNameValidation').textContent = 'Role name is required.';
                        return;
                    }

                    createSystemRole(roleName);
                });
            }

            // ========== ROLE MANAGEMENT FUNCTIONS ==========

            // Function to load user roles via AJAX
            function loadUserRoles(userId) {
                fetch(`?handler=RolesData&id=${userId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        displayUserRoles(data.roles, data.userId);
                    })
                    .catch(error => {
                        console.error('Error loading user roles:', error);
                        showRolesMessage('Error loading user roles. Please try again.', 'danger');
                    });
            }

            // Function to load available roles for dropdown
            function loadAvailableRoles() {
                fetch('?handler=AllRolesData')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(roles => {
                        populateRolesDropdown(roles);
                    })
                    .catch(error => {
                        console.error('Error loading available roles:', error);
                        document.getElementById('newRoleName').innerHTML = '<option value="">Error loading roles</option>';
                    });
            }

            // Function to load all system roles for management
            function loadAllSystemRoles() {
                fetch('?handler=AllRolesData')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(roles => {
                        displaySystemRoles(roles);
                    })
                    .catch(error => {
                        console.error('Error loading system roles:', error);
                        showManageRolesMessage('Error loading system roles. Please try again.', 'danger');
                    });
            }

            // Function to display user roles
            function displayUserRoles(roles, userId) {
                var rolesList = document.getElementById('currentRolesList');
                rolesList.innerHTML = '';

                if (roles && roles.length > 0) {
                    roles.forEach(function(role) {
                        var listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            ${role}
                            <button type="button" class="btn btn-danger btn-sm remove-role-btn"
                                    data-userid="${userId}" data-rolename="${role}">
                                Remove
                            </button>
                        `;
                        rolesList.appendChild(listItem);
                    });

                    // Add event listeners to remove buttons
                    document.querySelectorAll('.remove-role-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            var userId = this.getAttribute('data-userid');
                            var roleName = this.getAttribute('data-rolename');
                            removeUserRole(userId, roleName);
                        });
                    });
                } else {
                    rolesList.innerHTML = '<li class="list-group-item text-muted">No roles assigned.</li>';
                }
            }

            // Function to populate roles dropdown
            function populateRolesDropdown(roles) {
                var select = document.getElementById('newRoleName');
                select.innerHTML = '<option value="">Select a role...</option>';
                
                if (roles && roles.length > 0) {
                    roles.forEach(role => {
                        var option = document.createElement('option');
                        option.value = role;
                        option.textContent = role;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No roles available</option>';
                }
            }

            // Function to display system roles in management modal
            function displaySystemRoles(roles) {
                var rolesList = document.getElementById('systemRolesList');
                rolesList.innerHTML = '';

                if (roles && roles.length > 0) {
                    roles.forEach(function(role) {
                        var listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            ${role}
                            <button type="button" class="btn btn-danger btn-sm delete-system-role-btn"
                                    data-rolename="${role}">
                                Delete
                            </button>
                        `;
                        rolesList.appendChild(listItem);
                    });

                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-system-role-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            var roleName = this.getAttribute('data-rolename');
                            if (confirm(`Are you sure you want to delete the role "${roleName}"?`)) {
                                deleteSystemRole(roleName);
                            }
                        });
                    });
                } else {
                    rolesList.innerHTML = '<li class="list-group-item text-muted">No roles in system.</li>';
                }
            }

            // Function to add role to user via AJAX
            function addUserRole(userId, roleName) {
                var formData = new FormData();
                formData.append('id', userId);
                formData.append('roleName', roleName);

                fetch('?handler=AddRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Reload the roles list and refresh dropdown
                    loadUserRoles(userId);
                    loadAvailableRoles();
                    document.getElementById('newRoleName').value = '';
                    document.getElementById('roleNameValidation').textContent = '';
                    
                    showRolesMessage('Role added successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error adding role:', error);
                    showRolesMessage('Error adding role. Please try again.', 'danger');
                });
            }

            // Function to remove role from user via AJAX
            function removeUserRole(userId, roleName) {
                var formData = new FormData();
                formData.append('id', userId);
                formData.append('roleName', roleName);

                fetch('?handler=RemoveRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Reload the roles list and refresh dropdown
                    loadUserRoles(userId);
                    loadAvailableRoles();
                    
                    showRolesMessage('Role removed successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error removing role:', error);
                    showRolesMessage('Error removing role. Please try again.', 'danger');
                });
            }

            // Function to create system role via AJAX
            function createSystemRole(roleName) {
                var formData = new FormData();
                formData.append('roleName', roleName);

                fetch('?handler=CreateRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Refresh system roles list and clear form
                    loadAllSystemRoles();
                    document.getElementById('newSystemRoleName').value = '';
                    document.getElementById('systemRoleNameValidation').textContent = '';
                    
                    showManageRolesMessage('Role created successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error creating role:', error);
                    showManageRolesMessage('Error creating role. Please try again.', 'danger');
                });
            }

            // Function to delete system role via AJAX
            function deleteSystemRole(roleName) {
                var formData = new FormData();
                formData.append('roleName', roleName);

                fetch('?handler=DeleteRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Refresh system roles list
                    loadAllSystemRoles();
                    
                    showManageRolesMessage('Role deleted successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error deleting role:', error);
                    showManageRolesMessage('Error deleting role. Please try again.', 'danger');
                });
            }

            // Helper functions for showing messages
            function showRolesMessage(message, type) {
                var messageDiv = document.getElementById('rolesModalMessage');
                messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }

            function showManageRolesMessage(message, type) {
                var messageDiv = document.getElementById('manageRolesMessage');
                messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }
                    // Invite Users Modal and Form Handling
        var inviteUsersModal = document.getElementById('inviteUsersModal');
        if (inviteUsersModal) {
            inviteUsersModal.addEventListener('show.bs.modal', function () {
                document.getElementById('inviteUsersMessage').innerHTML = '';
                document.getElementById('inviteEmails').value = '';
                document.getElementById('inviteRole').value = 'User';
            });
        }

                // Invite Users Form Submission
        var inviteUsersForm = document.getElementById('inviteUsersForm');
        if (inviteUsersForm) {
            inviteUsersForm.addEventListener('submit', function (event) {
                event.preventDefault();

                var emailsText = document.getElementById('inviteEmails').value.trim();
                var role = document.getElementById('inviteRole').value;
                var sendBtn = document.getElementById('sendInvitationsBtn');
                var spinner = sendBtn.querySelector('.spinner-border');

                if (!emailsText) {
                    showInviteUsersMessage('Please enter at least one email address.', 'danger');
                    return;
                }

                 // Parse emails - split by commas or new lines
        var emails = emailsText.split(/[\n,]/)
            .map(email => email.trim())
            .filter(email => email.length > 0);

        if (emails.length === 0) {
            showInviteUsersMessage('Please enter at least one valid email address.', 'danger');
            return;
        }

        // Validate email formats
        var invalidEmails = emails.filter(email => !isValidEmail(email));
        if (invalidEmails.length > 0) {
            showInviteUsersMessage('Invalid email format: ' + invalidEmails.join(', '), 'danger');
            return;
        }

                // Show loading state
                sendBtn.disabled = true;
                spinner.classList.remove('d-none');

                var dto = {
                    emails: emails,
                    role: role
                };

                fetch('/api/Invitations/multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(dto)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Show success message with summary
                    var message = `Successfully sent ${data.successfulCount} invitation(s).`;
                    if (data.failedCount > 0) {
                        message += ` ${data.failedCount} invitation(s) failed.`;

                        // Show failed invitations details
                        if (data.failedInvitations && data.failedInvitations.length > 0) {
                            var failedDetails = data.failedInvitations.map(f => `${f.email}: ${f.error}`).join('<br>');
                            message += `<br><br><strong>Failed invitations:</strong><br>${failedDetails}`;
                        }
                    }

                    showInviteUsersMessage(message, data.failedCount > 0 ? 'warning' : 'success');

                    // Clear form if all successful, otherwise keep for editing
                    if (data.failedCount === 0) {
                        document.getElementById('inviteEmails').value = '';
                    }
                })
                .catch(error => {
                    console.error('Error sending invitations:', error);
                    showInviteUsersMessage('Error sending invitations. Please try again.', 'danger');
                })
                .finally(() => {
                    // Reset loading state
                    sendBtn.disabled = false;
                    spinner.classList.add('d-none');
                });
            });
        }


        
        });

    </script>
}
 *@









 @page
@model Portal.Pages.Users.IndexModel
@{
    ViewData["Title"] = "User Management";
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Users (@Model.TotalCount Total)</h1>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#inviteUsersModal">
                <i class="bi bi-person-plus"></i> Invite Users
            </button>
            <button class="btn btn-secondary me-2" data-bs-toggle="modal" data-bs-target="#manageRolesModal">Manage Roles</button>
        </div>
    </div>

    <form method="get" class="mb-3">
        <div class="row">
            <div class="col-md-4">
                <input asp-for="Search" class="form-control" placeholder="Search by name or email" />
            </div>
            <div class="col-md-3">
                <select asp-for="DepartmentId" class="form-select">
                    <option value="">All Departments</option>
                    @foreach (var dept in Model.Departments.Skip(1))
                    {
                        <option value="@dept.Value">@dept.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <select asp-for="IsActive" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-info">@Model.Message</div>
    }

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Job Role</th>
                    <th>Department</th>
                    <th>Active</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model.Users)
                {
                    <tr>
                        <td>@user.FirstName @user.Surname</td>
                        <td>@user.Email</td>
                        <td>@user.JobRole</td>
                        <td>@Model.Departments.FirstOrDefault(d => d.Value == user.DepartmentId)?.Text</td>
                        <td>
                            <span class="badge @(user.IsActive ? "bg-success" : "bg-danger")">
                                @(user.IsActive ? "Yes" : "No")
                            </span>
                        </td>
                        <td>@user.DateCreated.ToShortDateString()</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editModal"
                                    data-id="@user.Id"
                                    data-firstname="@user.FirstName"
                                    data-surname="@user.Surname"
                                    data-othernames="@user.OtherNames"
                                    data-dateofbirth="@(user.DateOfBirth?.ToString("yyyy-MM-dd"))"
                                    data-address="@user.Address"
                                    data-jobrole="@user.JobRole"
                                    data-profileimage="@user.ProfileImage"
                                    data-isactive="@user.IsActive.ToString().ToLower()"
                                    data-departmentid="@user.DepartmentId">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn @(user.IsActive ? "btn-warning" : "btn-success") btn-sm me-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#@(user.IsActive ? "deactivateModal" : "activateModal")"
                                    data-id="@user.Id">
                                <i class="bi bi-power"></i> @(user.IsActive ? "Deactivate" : "Activate")
                            </button>
                            <button class="btn btn-info btn-sm me-1 roles-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rolesModal"
                                    data-userid="@user.Id"
                                    data-username="@user.FirstName @user.Surname">
                                <i class="bi bi-key"></i> Roles
                            </button>
                            <button class="btn btn-secondary btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#resetModal"
                                    data-id="@user.Id">
                                <i class="bi bi-lock"></i> Reset PW
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Pagination">
        <ul class="pagination justify-content-center">
            @if (Model.CurrentPage > 1)
            {
                <li class="page-item">
                    <a class="page-link" asp-page="./Index" asp-route-page="@(Model.CurrentPage - 1)" asp-route-search="@Model.Search" asp-route-departmentId="@Model.DepartmentId" asp-route-isActive="@Model.IsActive">Previous</a>
                </li>
            }
            <li class="page-item disabled"><a class="page-link">Page @Model.CurrentPage of @Math.Ceiling((double)Model.TotalCount / Model.PageSize)</a></li>
            @if (Model.CurrentPage < Math.Ceiling((double)Model.TotalCount / Model.PageSize))
            {
                <li class="page-item">
                    <a class="page-link" asp-page="./Index" asp-route-page="@(Model.CurrentPage + 1)" asp-route-search="@Model.Search" asp-route-departmentId="@Model.DepartmentId" asp-route-isActive="@Model.IsActive">Next</a>
                </li>
            }
        </ul>
    </nav>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="Update" id="editUserForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                    <input type="hidden" id="editUserId" asp-for="UpdateDto.Id" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.FirstName" class="form-label">First Name</label>
                                <input type="text" id="editFirstName" asp-for="UpdateDto.FirstName" class="form-control" />
                                <span asp-validation-for="UpdateDto.FirstName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Surname" class="form-label">Surname</label>
                                <input type="text" id="editSurname" asp-for="UpdateDto.Surname" class="form-control" />
                                <span asp-validation-for="UpdateDto.Surname" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.OtherNames" class="form-label">Other Names</label>
                                <input type="text" id="editOtherNames" asp-for="UpdateDto.OtherNames" class="form-control" />
                                <span asp-validation-for="UpdateDto.OtherNames" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DateOfBirth" class="form-label">Date of Birth</label>
                                <input type="date" id="editDateOfBirth" asp-for="UpdateDto.DateOfBirth" class="form-control" />
                                <span asp-validation-for="UpdateDto.DateOfBirth" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="UpdateDto.Address" class="form-label">Address</label>
                        <textarea id="editAddress" asp-for="UpdateDto.Address" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="UpdateDto.Address" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.JobRole" class="form-label">Job Role</label>
                                <input type="text" id="editJobRole" asp-for="UpdateDto.JobRole" class="form-control" />
                                <span asp-validation-for="UpdateDto.JobRole" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.ProfileImage" class="form-label">Profile Image URL</label>
                                <input type="text" id="editProfileImage" asp-for="UpdateDto.ProfileImage" class="form-control" />
                                <span asp-validation-for="UpdateDto.ProfileImage" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.IsActive" class="form-label">Status</label>
                                <select id="editIsActive" asp-for="UpdateDto.IsActive" class="form-select">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                                <span asp-validation-for="UpdateDto.IsActive" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DepartmentId" class="form-label">Department</label>
                                <select id="editDepartmentId" asp-for="UpdateDto.DepartmentId" class="form-select">
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department.Value">@department.Text</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.DepartmentId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Deactivate Modal -->
<div class="modal fade" id="deactivateModal" tabindex="-1" aria-labelledby="deactivateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deactivateModalLabel">Confirm Deactivation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to deactivate this user?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-page-handler="ToggleActivation" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="deactivateId" />
                    <input type="hidden" name="isActive" value="false" />
                    <button type="submit" class="btn btn-danger">Deactivate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Activate Modal -->
<div class="modal fade" id="activateModal" tabindex="-1" aria-labelledby="activateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activateModalLabel">Confirm Activation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to activate this user?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-page-handler="ToggleActivation" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="activateId" />
                    <input type="hidden" name="isActive" value="true" />
                    <button type="submit" class="btn btn-success">Activate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Roles Modal -->
<div class="modal fade" id="rolesModal" tabindex="-1" aria-labelledby="rolesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rolesModalLabel">Manage Roles for <span id="rolesUserName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="rolesModalMessage"></div>

                <h6>Current Roles:</h6>
                <ul class="list-group mb-3" id="currentRolesList">
                    <!-- Roles will be populated via JavaScript -->
                </ul>

                <h6>Add New Role:</h6>
                <form id="addRoleForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="rolesUserId" name="id" />
                    <div class="input-group mb-3">
                        <select id="newRoleName" name="roleName" class="form-select" required>
                            <option value="">Select a role...</option>
                        </select>
                        <button type="submit" class="btn btn-success">Add Role</button>
                    </div>
                    <span id="roleNameValidation" class="text-danger"></span>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Roles Modal -->
<div class="modal fade" id="manageRolesModal" tabindex="-1" aria-labelledby="manageRolesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageRolesModalLabel">Manage System Roles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="manageRolesMessage"></div>

                <h6>Current Roles:</h6>
                <ul class="list-group mb-3" id="systemRolesList">
                    <!-- Roles will be populated via JavaScript -->
                </ul>

                <h6>Create New Role:</h6>
                <form id="createRoleForm">
                    @Html.AntiForgeryToken()
                    <div class="input-group mb-3">
                        <input type="text" id="newSystemRoleName" name="roleName" class="form-control" placeholder="Role Name" required />
                        <button type="submit" class="btn btn-success">Create Role</button>
                    </div>
                    <span id="systemRoleNameValidation" class="text-danger"></span>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Invite Users Modal -->
<div class="modal fade" id="inviteUsersModal" tabindex="-1" aria-labelledby="inviteUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteUsersModalLabel">Invite Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="SendInvitations">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label asp-for="InviteEmails" class="form-label">Email Addresses</label>
                        <textarea asp-for="InviteEmails" class="form-control" rows="5" 
                                  placeholder="Enter email addresses, one per line or separated by commas"></textarea>
                        <span asp-validation-for="InviteEmails" class="text-danger"></span>
                        <div class="form-text">Enter multiple email addresses separated by commas, semicolons, or new lines.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="InviteRole" class="form-label">Role</label>
                        <select asp-for="InviteRole" class="form-select">
                            @foreach (var role in Model.AvailableRoles)
                            {
                                <option value="@role">@role</option>
                            }
                        </select>
                        <span asp-validation-for="InviteRole" class="text-danger"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        Send Invitations
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Invitations List Section -->
@if (Model.Invitations.Any())
{
    <div class="mt-4">
        <h3>Pending Invitations</h3>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Expires</th>
                        <th>Invited By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var invitation in Model.Invitations)
                    {
                        <tr>
                            <td>@invitation.Email</td>
                            <td>@invitation.Role</td>
                            <td>
                                <span class="badge @(invitation.IsUsed ? "bg-success" : invitation.ExpiresAt < DateTime.UtcNow ? "bg-danger" : "bg-warning")">
                                    @(invitation.IsUsed ? "Used" : invitation.ExpiresAt < DateTime.UtcNow ? "Expired" : "Pending")
                                </span>
                            </td>
                            <td>@invitation.ExpiresAt.ToString("MMM dd, yyyy HH:mm")</td>
                            <td>@invitation.InvitedByUserName</td>
                            <td>
                                @if (!invitation.IsUsed && invitation.ExpiresAt > DateTime.UtcNow)
                                {
                                    <form method="post" asp-page-handler="ResendInvitation" style="display: inline;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@invitation.Id" />
                                        <button type="submit" class="btn btn-warning btn-sm me-1">Resend</button>
                                    </form>
                                }
                                <form method="post" asp-page-handler="DeleteInvitation" style="display: inline;">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@invitation.Id" />
                                    <button type="submit" class="btn btn-danger btn-sm" 
                                            onclick="return confirm('Are you sure you want to delete this invitation?')">Delete</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<!-- Reset Password Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">Confirm Password Reset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reset the password for this user? A reset token will be generated.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-page-handler="ResetPassword" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="resetId" />
                    <button type="submit" class="btn btn-warning">Reset Password</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Helper function to get anti-forgery token
            function getAntiForgeryToken() {
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (!token) {
                    console.error('Anti-forgery token not found');
                    return null;
                }
                return token.value;
            }

            // Edit Modal
            var editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('editUserId').value = button.getAttribute('data-id');
                    document.getElementById('editFirstName').value = button.getAttribute('data-firstname') || '';
                    document.getElementById('editSurname').value = button.getAttribute('data-surname') || '';
                    document.getElementById('editOtherNames').value = button.getAttribute('data-othernames') || '';
                    document.getElementById('editDateOfBirth').value = button.getAttribute('data-dateofbirth') || '';
                    document.getElementById('editAddress').value = button.getAttribute('data-address') || '';
                    document.getElementById('editJobRole').value = button.getAttribute('data-jobrole') || '';
                    document.getElementById('editProfileImage').value = button.getAttribute('data-profileimage') || '';

                    var isActiveValue = button.getAttribute('data-isactive');
                    if (isActiveValue) {
                        document.getElementById('editIsActive').value = isActiveValue;
                    }

                    var departmentIdValue = button.getAttribute('data-departmentid');
                    if (departmentIdValue) {
                        document.getElementById('editDepartmentId').value = departmentIdValue;
                    }
                });
            }

            // Deactivate Modal
            var deactivateModal = document.getElementById('deactivateModal');
            if (deactivateModal) {
                deactivateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('deactivateId').value = button.getAttribute('data-id');
                });
            }

            // Activate Modal
            var activateModal = document.getElementById('activateModal');
            if (activateModal) {
                activateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('activateId').value = button.getAttribute('data-id');
                });
            }

            // Reset Modal
            var resetModal = document.getElementById('resetModal');
            if (resetModal) {
                resetModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('resetId').value = button.getAttribute('data-id');
                });
            }

            // Roles Modal
            var rolesModal = document.getElementById('rolesModal');
            if (rolesModal) {
                rolesModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var userId = button.getAttribute('data-userid');
                    var userName = button.getAttribute('data-username');

                    document.getElementById('rolesUserId').value = userId;
                    document.getElementById('rolesUserName').textContent = userName;
                    document.getElementById('currentRolesList').innerHTML = '';
                    document.getElementById('rolesModalMessage').innerHTML = '';
                    document.getElementById('newRoleName').innerHTML = '<option value="">Loading roles...</option>';
                    document.getElementById('roleNameValidation').textContent = '';

                    loadUserRoles(userId);
                    loadAvailableRoles();
                });
            }

            // Manage Roles Modal
            var manageRolesModal = document.getElementById('manageRolesModal');
            if (manageRolesModal) {
                manageRolesModal.addEventListener('show.bs.modal', function (event) {
                    document.getElementById('manageRolesMessage').innerHTML = '';
                    document.getElementById('systemRoleNameValidation').textContent = '';
                    document.getElementById('newSystemRoleName').value = '';
                    loadAllSystemRoles();
                });
            }

            // Add Role Form Submission
            var addRoleForm = document.getElementById('addRoleForm');
            if (addRoleForm) {
                addRoleForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    var userId = document.getElementById('rolesUserId').value;
                    var roleName = document.getElementById('newRoleName').value;

                    if (!roleName.trim()) {
                        document.getElementById('roleNameValidation').textContent = 'Please select a role.';
                        return;
                    }

                    addUserRole(userId, roleName);
                });
            }

            // Create Role Form Submission
            var createRoleForm = document.getElementById('createRoleForm');
            if (createRoleForm) {
                createRoleForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    var roleName = document.getElementById('newSystemRoleName').value.trim();

                    if (!roleName) {
                        document.getElementById('systemRoleNameValidation').textContent = 'Role name is required.';
                        return;
                    }

                    createSystemRole(roleName);
                });
            }

            // ========== ROLE MANAGEMENT FUNCTIONS ==========

            function loadUserRoles(userId) {
                const token = getAntiForgeryToken();
                if (!token) {
                    showRolesMessage('Security token missing. Please refresh the page.', 'danger');
                    return;
                }

                fetch(`?handler=RolesData&id=${userId}`, {
                    headers: {
                        'RequestVerificationToken': token
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    displayUserRoles(data.roles, data.userId);
                })
                .catch(error => {
                    console.error('Error loading user roles:', error);
                    showRolesMessage('Error loading user roles. Please try again.', 'danger');
                });
            }

            function loadAvailableRoles() {
                const token = getAntiForgeryToken();
                if (!token) return;

                fetch('?handler=AllRolesData', {
                    headers: {
                        'RequestVerificationToken': token
                    }
                })
                .then(response => {if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(roles => {
                    populateRolesDropdown(roles);
                })
                .catch(error => {
                    console.error('Error loading available roles:', error);
                    document.getElementById('newRoleName').innerHTML = '<option value="">Error loading roles</option>';
                });
            }

            function loadAllSystemRoles() {
                const token = getAntiForgeryToken();
                if (!token) return;

                fetch('?handler=AllRolesData', {
                    headers: {
                        'RequestVerificationToken': token
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(roles => {
                    displaySystemRoles(roles);
                })
                .catch(error => {
                    console.error('Error loading system roles:', error);
                    showManageRolesMessage('Error loading system roles. Please try again.', 'danger');
                });
            }

            function displayUserRoles(roles, userId) {
                var rolesList = document.getElementById('currentRolesList');
                rolesList.innerHTML = '';

                if (roles && roles.length > 0) {
                    roles.forEach(function(role) {
                        var listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            ${role}
                            <button type="button" class="btn btn-danger btn-sm remove-role-btn"
                                    data-userid="${userId}" data-rolename="${role}">
                                Remove
                            </button>
                        `;
                        rolesList.appendChild(listItem);
                    });

                    document.querySelectorAll('.remove-role-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            var userId = this.getAttribute('data-userid');
                            var roleName = this.getAttribute('data-rolename');
                            removeUserRole(userId, roleName);
                        });
                    });
                } else {
                    rolesList.innerHTML = '<li class="list-group-item text-muted">No roles assigned.</li>';
                }
            }

            function populateRolesDropdown(roles) {
                var select = document.getElementById('newRoleName');
                select.innerHTML = '<option value="">Select a role...</option>';

                if (roles && roles.length > 0) {
                    roles.forEach(role => {
                        var option = document.createElement('option');
                        option.value = role;
                        option.textContent = role;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No roles available</option>';
                }
            }

            function displaySystemRoles(roles) {
                var rolesList = document.getElementById('systemRolesList');
                rolesList.innerHTML = '';

                if (roles && roles.length > 0) {
                    roles.forEach(function(role) {
                        var listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            ${role}
                            <button type="button" class="btn btn-danger btn-sm delete-system-role-btn"
                                    data-rolename="${role}">
                                Delete
                            </button>
                        `;
                        rolesList.appendChild(listItem);
                    });

                    document.querySelectorAll('.delete-system-role-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            var roleName = this.getAttribute('data-rolename');
                            if (confirm(`Are you sure you want to delete the role "${roleName}"?`)) {
                                deleteSystemRole(roleName);
                            }
                        });
                    });
                } else {
                    rolesList.innerHTML = '<li class="list-group-item text-muted">No roles in system.</li>';
                }
            }

            function addUserRole(userId, roleName) {
                const token = getAntiForgeryToken();
                if (!token) {
                    showRolesMessage('Security token missing. Please refresh the page.', 'danger');
                    return;
                }

                var formData = new FormData();
                formData.append('id', userId);
                formData.append('roleName', roleName);
                formData.append('__RequestVerificationToken', token);

                fetch('?handler=AddRole', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    return response.text().then(text => {
                        throw new Error(text || 'Failed to add role');
                    });
                })
                .then(message => {
                    loadUserRoles(userId);
                    loadAvailableRoles();
                    document.getElementById('newRoleName').value = '';
                    document.getElementById('roleNameValidation').textContent = '';
                    showRolesMessage('Role added successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error adding role:', error);
                    showRolesMessage('Error adding role: ' + error.message, 'danger');
                });
            }

            function removeUserRole(userId, roleName) {
                const token = getAntiForgeryToken();
                if (!token) {
                    showRolesMessage('Security token missing. Please refresh the page.', 'danger');
                    return;
                }

                var formData = new FormData();
                formData.append('id', userId);
                formData.append('roleName', roleName);
                formData.append('__RequestVerificationToken', token);

                fetch('?handler=RemoveRole', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    return response.text().then(text => {
                        throw new Error(text || 'Failed to remove role');
                    });
                })
                .then(message => {
                    loadUserRoles(userId);
                    loadAvailableRoles();
                    showRolesMessage('Role removed successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error removing role:', error);
                    showRolesMessage('Error removing role: ' + error.message, 'danger');
                });
            }

            function createSystemRole(roleName) {
                const token = getAntiForgeryToken();
                if (!token) {
                    showManageRolesMessage('Security token missing. Please refresh the page.', 'danger');
                    return;
                }

                var formData = new FormData();
                formData.append('roleName', roleName);
                formData.append('__RequestVerificationToken', token);

                fetch('?handler=CreateRole', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    return response.text().then(text => {
                        throw new Error(text || 'Failed to create role');
                    });
                })
                .then(message => {
                    loadAllSystemRoles();
                    document.getElementById('newSystemRoleName').value = '';
                    document.getElementById('systemRoleNameValidation').textContent = '';
                    showManageRolesMessage('Role created successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error creating role:', error);
                    showManageRolesMessage('Error creating role: ' + error.message, 'danger');
                });
            }

            function deleteSystemRole(roleName) {
                const token = getAntiForgeryToken();
                if (!token) {
                    showManageRolesMessage('Security token missing. Please refresh the page.', 'danger');
                    return;
                }

                var formData = new FormData();
                formData.append('roleName', roleName);
                formData.append('__RequestVerificationToken', token);

                fetch('?handler=DeleteRole', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    return response.text().then(text => {
                        throw new Error(text || 'Failed to delete role');
                    });
                })
                .then(message => {
                    loadAllSystemRoles();
                    showManageRolesMessage('Role deleted successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error deleting role:', error);
                    showManageRolesMessage('Error deleting role: ' + error.message, 'danger');
                });
            }

            function showRolesMessage(message, type) {
                var messageDiv = document.getElementById('rolesModalMessage');
                messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }

            function showManageRolesMessage(message, type) {
                var messageDiv = document.getElementById('manageRolesMessage');
                messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }
        });
    </script>
}


  