@page
@model Portal.Pages.Users.IndexModel
@{
    ViewData["Title"] = "User Management";
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Users (@Model.TotalCount Total)</h1>
    </div>

    <form method="get" class="mb-3">
        <div class="row">
            <div class="col-md-4">
                <input asp-for="Search" class="form-control" placeholder="Search by name or email" />
            </div>
            <div class="col-md-3">
                <select asp-for="DepartmentId" class="form-select">
                    <option value="">All Departments</option>
                    @foreach (var dept in Model.Departments.Skip(1))
                    {
                        <option value="@dept.Value">@dept.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <select asp-for="IsActive" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-info">@Model.Message</div>
    }

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Job Role</th>
                    <th>Department</th>
                    <th>Active</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model.Users)
                {
                    <tr>
                        <td>@user.FirstName @user.Surname</td>
                        <td>@user.Email</td>
                        <td>@user.JobRole</td>
                        <td>@Model.Departments.FirstOrDefault(d => d.Value == user.DepartmentId)?.Text</td>
                        <td>@(user.IsActive ? "Yes" : "No")</td>
                        <td>@user.DateCreated.ToShortDateString()</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editModal"
                                    data-id="@user.Id"
                                    data-firstname="@user.FirstName"
                                    data-surname="@user.Surname"
                                    data-othernames="@user.OtherNames"
                                    data-dateofbirth="@(user.DateOfBirth?.ToString("yyyy-MM-dd"))"
                                    data-address="@user.Address"
                                    data-jobrole="@user.JobRole"
                                    data-profileimage="@user.ProfileImage"
                                    data-isactive="@user.IsActive.ToString().ToLower()"
                                    data-departmentid="@user.DepartmentId">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-warning btn-sm me-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#@(user.IsActive ? "deactivateModal" : "activateModal")"
                                    data-id="@user.Id">
                                <i class="bi bi-power"></i> @(user.IsActive ? "Deactivate" : "Activate")
                            </button>
                            <!-- Change the Roles button to use data attributes instead of anchor tag -->
                            <button class="btn btn-info btn-sm me-2 roles-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rolesModal"
                                    data-userid="@user.Id">
                                <i class="bi bi-key"></i> Roles
                            </button>
                            <button class="btn btn-secondary btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#resetModal"
                                    data-id="@user.Id">
                                <i class="bi bi-lock"></i> Reset PW
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Pagination">
        <ul class="pagination justify-content-center">
            @if (Model.CurrentPage > 1)
            {
                <li class="page-item">
                    <a class="page-link" asp-page="./Index" asp-route-page="@(Model.CurrentPage - 1)" asp-route-search="@Model.Search" asp-route-departmentId="@Model.DepartmentId" asp-route-isActive="@Model.IsActive">Previous</a>
                </li>
            }
            <li class="page-item disabled"><a class="page-link">Page @Model.CurrentPage of @Math.Ceiling((double)Model.TotalCount / Model.PageSize)</a></li>
            @if (Model.CurrentPage < Math.Ceiling((double)Model.TotalCount / Model.PageSize))
            {
                <li class="page-item">
                    <a class="page-link" asp-page="./Index" asp-route-page="@(Model.CurrentPage + 1)" asp-route-search="@Model.Search" asp-route-departmentId="@Model.DepartmentId" asp-route-isActive="@Model.IsActive">Next</a>
                </li>
            }
        </ul>
    </nav>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="Update">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>
                    <input type="hidden" asp-for="UpdateDto.Id" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.FirstName" class="form-label"></label>
                                <input asp-for="UpdateDto.FirstName" class="form-control" />
                                <span asp-validation-for="UpdateDto.FirstName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.Surname" class="form-label"></label>
                                <input asp-for="UpdateDto.Surname" class="form-control" />
                                <span asp-validation-for="UpdateDto.Surname" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.OtherNames" class="form-label"></label>
                                <input asp-for="UpdateDto.OtherNames" class="form-control" />
                                <span asp-validation-for="UpdateDto.OtherNames" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DateOfBirth" class="form-label"></label>
                                <input asp-for="UpdateDto.DateOfBirth" type="date" class="form-control" />
                                <span asp-validation-for="UpdateDto.DateOfBirth" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="UpdateDto.Address" class="form-label"></label>
                        <textarea asp-for="UpdateDto.Address" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="UpdateDto.Address" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.JobRole" class="form-label"></label>
                                <input asp-for="UpdateDto.JobRole" class="form-control" />
                                <span asp-validation-for="UpdateDto.JobRole" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.ProfileImage" class="form-label"></label>
                                <input asp-for="UpdateDto.ProfileImage" class="form-control" />
                                <span asp-validation-for="UpdateDto.ProfileImage" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.IsActive" class="form-label"></label>
                                <select asp-for="UpdateDto.IsActive" class="form-select">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                                <span asp-validation-for="UpdateDto.IsActive" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UpdateDto.DepartmentId" class="form-label">Department</label>
                                <select asp-for="UpdateDto.DepartmentId" class="form-select">
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department.Value">@department.Text</option>
                                    }
                                </select>
                                <span asp-validation-for="UpdateDto.DepartmentId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Deactivate Modal -->
<div class="modal fade" id="deactivateModal" tabindex="-1" aria-labelledby="deactivateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deactivateModalLabel">Confirm Deactivation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to deactivate this user?</p>
                <form method="post" asp-page-handler="ToggleActivation">
                    <input type="hidden" name="id" id="deactivateId" />
                    <input type="hidden" name="isActive" value="false" />
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Deactivate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Activate Modal -->
<div class="modal fade" id="activateModal" tabindex="-1" aria-labelledby="activateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activateModalLabel">Confirm Activation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to activate this user?</p>
                <form method="post" asp-page-handler="ToggleActivation">
                    <input type="hidden" name="id" id="activateId" />
                    <input type="hidden" name="isActive" value="true" />
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Activate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@* <!-- Roles Modal -->
@if (!string.IsNullOrEmpty(Model.SelectedUserId))
{
    <div class="modal @(Model.ActiveModal == "roles" ? "show d-block" : "fade")" id="rolesModal" tabindex="-1" aria-labelledby="rolesModalLabel" aria-hidden="true" style="@(Model.ActiveModal == "roles" ? "background-color: rgba(0,0,0,0.5);" : "")">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rolesModalLabel">Manage Roles for User</h5>
                    <a asp-page="./Index" class="btn-close" aria-label="Close"></a>
                </div>
                <div class="modal-body">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>

                    <h6>Current Roles:</h6>
                    @if (Model.Roles.Any())
                    {
                        <ul class="list-group mb-3">
                            @foreach (var role in Model.Roles)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    @role
                                    <form method="post" asp-page-handler="RemoveRole">
                                        <input type="hidden" name="id" value="@Model.SelectedUserId" />
                                        <input type="hidden" name="roleName" value="@role" />
                                        <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                                    </form>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted">No roles assigned.</p>
                    }

                    <h6>Add New Role:</h6>
                    <form method="post" asp-page-handler="AddRole">
                        <input type="hidden" name="id" value="@Model.SelectedUserId" />
                        <div class="input-group mb-3">
                            <input name="roleName" class="form-control" placeholder="Role Name" required />
                            <button type="submit" class="btn btn-success">Add Role</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <a asp-page="./Index" class="btn btn-secondary">Close</a>
                </div>
            </div>
        </div>
    </div>
} *@

<!-- Roles Modal -->
<div class="modal fade" id="rolesModal" tabindex="-1" aria-labelledby="rolesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rolesModalLabel">Manage Roles for User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="rolesModalMessage"></div>
                <div asp-validation-summary="All" class="text-danger mb-3"></div>

                <h6>Current Roles:</h6>
                <ul class="list-group mb-3" id="currentRolesList">
                    <!-- Roles will be populated via JavaScript -->
                </ul>

                <h6>Add New Role:</h6>
                <form id="addRoleForm">
                    <input type="hidden" id="rolesUserId" name="id" />
                    <div class="input-group mb-3">
                        <input id="newRoleName" name="roleName" class="form-control" placeholder="Role Name" required />
                        <button type="submit" class="btn btn-success">Add Role</button>
                    </div>
                    <span id="roleNameValidation" class="text-danger"></span>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Reset Password Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">Confirm Password Reset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reset the password for this user? A reset token will be generated.</p>
                <form method="post" asp-page-handler="ResetPassword">
                    <input type="hidden" name="id" id="resetId" />
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Reset Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Edit Modal
            var editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;

                    document.getElementById('UpdateDto_Id').value = button.getAttribute('data-id');
                    document.getElementById('UpdateDto_FirstName').value = button.getAttribute('data-firstname') || '';
                    document.getElementById('UpdateDto_Surname').value = button.getAttribute('data-surname') || '';
                    document.getElementById('UpdateDto_OtherNames').value = button.getAttribute('data-othernames') || '';
                    document.getElementById('UpdateDto_DateOfBirth').value = button.getAttribute('data-dateofbirth') || '';
                    document.getElementById('UpdateDto_Address').value = button.getAttribute('data-address') || '';
                    document.getElementById('UpdateDto_JobRole').value = button.getAttribute('data-jobrole') || '';
                    document.getElementById('UpdateDto_ProfileImage').value = button.getAttribute('data-profileimage') || '';
                    document.getElementById('UpdateDto_IsActive').value = button.getAttribute('data-isactive');
                    document.getElementById('UpdateDto_DepartmentId').value = button.getAttribute('data-departmentid') || '';
                });
            }

            // Deactivate Modal
            var deactivateModal = document.getElementById('deactivateModal');
            if (deactivateModal) {
                deactivateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('deactivateId').value = button.getAttribute('data-id');
                });
            }

            // Activate Modal
            var activateModal = document.getElementById('activateModal');
            if (activateModal) {
                activateModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('activateId').value = button.getAttribute('data-id');
                });
            }

            // Reset Modal
            var resetModal = document.getElementById('resetModal');
            if (resetModal) {
                resetModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('resetId').value = button.getAttribute('data-id');
                });
            }

            


            // Roles Modal - Enhanced with AJAX
            var rolesModal = document.getElementById('rolesModal');
            if (rolesModal) {
                rolesModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var userId = button.getAttribute('data-userid');

                    // Set the user ID in the hidden field
                    document.getElementById('rolesUserId').value = userId;

                    // Clear previous roles and message
                    document.getElementById('currentRolesList').innerHTML = '';
                    document.getElementById('rolesModalMessage').innerHTML = '';
                    document.getElementById('newRoleName').value = '';
                    document.getElementById('roleNameValidation').textContent = '';

                    // Load user roles via AJAX
                    loadUserRoles(userId);
                });
            }

            // Add Role Form Submission
            var addRoleForm = document.getElementById('addRoleForm');
            if (addRoleForm) {
                addRoleForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    var userId = document.getElementById('rolesUserId').value;
                    var roleName = document.getElementById('newRoleName').value;

                    if (!roleName.trim()) {
                        document.getElementById('roleNameValidation').textContent = 'Role name is required.';
                        return;
                    }

                    addUserRole(userId, roleName);
                });
            }

            // Function to load user roles via AJAX
            function loadUserRoles(userId) {
                fetch(`?handler=RolesData&id=${userId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        displayUserRoles(data.roles, data.userId);
                    })
                    .catch(error => {
                        console.error('Error loading roles:', error);
                        document.getElementById('rolesModalMessage').innerHTML =
                            '<div class="alert alert-danger">Error loading roles. Please try again.</div>';
                    });
            }

            // Function to display user roles
            function displayUserRoles(roles, userId) {
                var rolesList = document.getElementById('currentRolesList');

                if (roles && roles.length > 0) {
                    roles.forEach(function(role) {
                        var listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            ${role}
                            <button type="button" class="btn btn-danger btn-sm remove-role-btn"
                                    data-userid="${userId}" data-rolename="${role}">
                                Remove
                            </button>
                        `;
                        rolesList.appendChild(listItem);
                    });

                    // Add event listeners to remove buttons
                    document.querySelectorAll('.remove-role-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            var userId = this.getAttribute('data-userid');
                            var roleName = this.getAttribute('data-rolename');
                            removeUserRole(userId, roleName);
                        });
                    });
                } else {
                    rolesList.innerHTML = '<li class="list-group-item text-muted">No roles assigned.</li>';
                }
            }

            // Function to add role via AJAX
            function addUserRole(userId, roleName) {
                var formData = new FormData();
                formData.append('id', userId);
                formData.append('roleName', roleName);

                fetch('?handler=AddRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Reload the roles list
                    loadUserRoles(userId);
                    document.getElementById('newRoleName').value = '';
                    document.getElementById('roleNameValidation').textContent = '';

                    // Show success message
                    document.getElementById('rolesModalMessage').innerHTML =
                        '<div class="alert alert-success">Role added successfully.</div>';
                })
                .catch(error => {
                    console.error('Error adding role:', error);
                    document.getElementById('rolesModalMessage').innerHTML =
                        '<div class="alert alert-danger">Error adding role. Please try again.</div>';
                });
            }

            // Function to remove role via AJAX
            function removeUserRole(userId, roleName) {
                var formData = new FormData();
                formData.append('id', userId);
                formData.append('roleName', roleName);

                fetch('?handler=RemoveRole', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(message => {
                    // Reload the roles list
                    loadUserRoles(userId);

                    // Show success message
                    document.getElementById('rolesModalMessage').innerHTML =
                        '<div class="alert alert-success">Role removed successfully.</div>';
                })
                .catch(error => {
                    console.error('Error removing role:', error);
                    document.getElementById('rolesModalMessage').innerHTML =
                        '<div class="alert alert-danger">Error removing role. Please try again.</div>';
                });
            }
        });
    </script>
}