name: Smart Deployment with Migrations (WebDeploy)

on:
  push:
    branches: [ master ]
    paths:
      - 'AssetTag/**'
      - 'Portal/**'
      - 'Shared/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.x'
  SOLUTION_PATH: 'AssetTag.sln'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.filter.outputs.api }}
      portal-changed: ${{ steps.filter.outputs.portal }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect project changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api:
              - 'AssetTag/**'
              - 'Shared/**'
              - '.github/workflows/**'
            portal:
              - 'Portal/**'
              - 'Shared/**'
              - '.github/workflows/**'

  build-and-publish:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.api-changed == 'true' || needs.detect-changes.outputs.portal-changed == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          workloads: maui-android

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Create publish directories
        run: |
          mkdir -p ./publish/api
          mkdir -p ./publish/portal

      - name: Build and Publish API (if changed)
        if: needs.detect-changes.outputs.api-changed == 'true'
        env:
          CONN: ${{ secrets.MONSTERASP_DATABASE_CONNECTION }}
          JWT: ${{ secrets.JWT_SECURITY_KEY }}
          EMAIL_USER: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASSWORD }}
          APIKey: ${{ secrets.API_KEY }}
        run: |
          dotnet publish AssetTag/AssetTag.csproj \
            --configuration Release \
            --output ./publish/api \
            -p:UseAppHost=false \
            -p:AspNetCoreHostingModel=OutOfProcess \
            -p:EnvironmentName=Production

          mkdir -p ./publish/api/logs

          cat > ./publish/api/appsettings.Production.json << EOF
          {
            "ConnectionStrings": { "DefaultConnection": "$CONN" },
            "JwtSettings": {
              "SecurityKey": "$JWT",
              "Issuer": "AssetTagApi",
              "Audience": "AssetTagApiClient"
            },
            "EmailSettings": {
              "Username": "$EMAIL_USER",
              "Password": "$EMAIL_PASS"
            },
            "Groq": {
            "ApiKey": "$APIKey"
            },
            "Logging": {
              "LogLevel": {
                "Default": "Information",
                "Microsoft.AspNetCore": "Warning"
              }
            }
          }
          EOF

          cat > ./publish/api/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <location path="." inheritInChildApplications="false">
              <system.webServer>
                <handlers>
                  <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified"/>
                </handlers>
                <aspNetCore processPath="dotnet" arguments=".\AssetTag.dll" stdoutLogEnabled="true" stdoutLogFile=".\logs\stdout" hostingModel="OutOfProcess">
                  <environmentVariables>
                    <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production"/>
                  </environmentVariables>
                </aspNetCore>
              </system.webServer>
            </location>
          </configuration>
          EOF

      - name: Build and Publish Portal (if changed)
        if: needs.detect-changes.outputs.portal-changed == 'true'
        run: |
          dotnet publish Portal/Portal.csproj \
            --configuration Release \
            --output ./publish/portal \
            -p:UseAppHost=false \
            -p:AspNetCoreHostingModel=OutOfProcess \
            -p:EnvironmentName=Production

          mkdir -p ./publish/portal/logs

          cat > ./publish/portal/appsettings.Production.json << 'EOF'
          {
            "Logging": {
              "LogLevel": {
                "Default": "Information",
                "Microsoft.AspNetCore": "Warning"
              }
            },
            "Api": { "BaseUrl": "http://mugassetapi.runasp.net/" },
            "Dashboard": {
              "EnableCaching": true,
              "CacheDurationMinutes": 5,
              "AutoRefreshIntervalMinutes": 2,
              "ChartAnimation": true,
              "LazyLoading": true
            },
            "Performance": {
              "MaxParallelRequests": 10,
              "RequestTimeoutSeconds": 30
            },
            "AllowedHosts": "*"
          }
          EOF

          cat > ./publish/portal/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <location path="." inheritInChildApplications="false">
              <system.webServer>
                <handlers>
                  <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified"/>
                </handlers>
                <aspNetCore processPath="dotnet" arguments=".\Portal.dll" stdoutLogEnabled="true" stdoutLogFile=".\logs\stdout" hostingModel="OutOfProcess">
                  <environmentVariables>
                    <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production"/>
                  </environmentVariables>
                </aspNetCore>
              </system.webServer>
            </location>
          </configuration>
          EOF

      - name: Upload API artifact
        if: needs.detect-changes.outputs.api-changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: api-deployment
          path: ./publish/api/

      - name: Upload Portal artifact
        if: needs.detect-changes.outputs.portal-changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: portal-deployment
          path: ./publish/portal/

  run-migrations:
    needs: [detect-changes, build-and-publish]
    if: needs.detect-changes.outputs.api-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Restore & Run EF Migrations
        env:
          ConnectionStrings__DefaultConnection: ${{ secrets.MONSTERASP_DATABASE_CONNECTION }}
        run: |
          dotnet tool install --global dotnet-ef --version 9.*
          dotnet ef database update \
            --project AssetTag/AssetTag.csproj \
            --startup-project AssetTag/AssetTag.csproj \
            --configuration Release
          echo "Database migrations applied successfully"

  # ========================================
  # DEPLOY API VIA WEB DEPLOY
  # ========================================
  deploy-api:
    needs: [detect-changes, build-and-publish, run-migrations]
    if: needs.detect-changes.outputs.api-changed == 'true'
    runs-on: windows-latest
    steps:
      - name: Download API artifact
        uses: actions/download-artifact@v4
        with:
          name: api-deployment
          path: api-deployment

      - name: Create DataProtection Keys folder
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path "api-deployment/App_Data/Keys"

      - name: Deploy API using Web Deploy
        uses: ChristopheLav/iis-deploy@v1
        with:
          website-name: ${{ secrets.API_WEBSITE_NAME }}
          msdeploy-service-url: ${{ secrets.API_DEPLOY_URL }}
          msdeploy-username: ${{ secrets.API_USERNAME }}
          msdeploy-password: ${{ secrets.API_USERPASSWORD }}
          source-path: api-deployment
          skip-extra-files: false   # deletes old files not in new publish (clean slate)
          enable-app-offline: true  # automatically handles app_offline.htm + graceful shutdown

  # ========================================
  # DEPLOY PORTAL VIA WEB DEPLOY
  # ========================================
  deploy-portal:
    needs: [detect-changes, build-and-publish]
    if: needs.detect-changes.outputs.portal-changed == 'true'
    runs-on: windows-latest
    steps:
      - name: Download Portal artifact
        uses: actions/download-artifact@v4
        with:
          name: portal-deployment
          path: portal-deployment

      - name: Create DataProtection Keys folder
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path "portal-deployment/App_Data/Keys"

      - name: Deploy Portal using Web Deploy
        uses: ChristopheLav/iis-deploy@v1
        with:
          website-name: ${{ secrets.PORTAL_WEBSITE_NAME }}
          msdeploy-service-url: ${{ secrets.PORTAL_DEPLOY_URL }}
          msdeploy-username: ${{ secrets.PORTAL_USERNAME }}
          msdeploy-password: ${{ secrets.PORTAL_USERPASSWORD }}
          source-path: portal-deployment
          skip-extra-files: false
          enable-app-offline: true

      - name: Portal deployed successfully
        run: echo "Portal is now live!"
