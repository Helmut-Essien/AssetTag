name: Smart Deployment with Migrations

on:
  push:
    branches: [master]
    paths:
      - 'AssetTag/**'
      - 'Portal/**'
      - 'Shared/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.x'
  SOLUTION_PATH: 'AssetTag.sln'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.filter.outputs.api }}
      portal-changed: ${{ steps.filter.outputs.portal }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Detect project changes
      id: filter
      uses: dorny/paths-filter@v3
      with:
        filters: |
          api:
            - 'AssetTag/**'
            - 'Shared/**'
            - '.github/workflows/**'
          portal:
            - 'Portal/**'
            - 'Shared/**'
            - '.github/workflows/**'

  build-and-publish:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.api-changed == 'true' || needs.detect-changes.outputs.portal-changed == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    
    # Create publish directories first
    - name: Create publish directories
      run: |
        mkdir -p ./publish/api
        mkdir -p ./publish/portal
    
    - name: Build and Publish API (if changed)
      if: needs.detect-changes.outputs.api-changed == 'true'
      env:
        JWT_SECURITY_KEY: ${{ secrets.JWT_SECURITY_KEY }}
        EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        ConnectionStrings__DefaultConnection: ${{ secrets.MONSTERASP_DATABASE_CONNECTION }}
      run: |
        # Clean previous build
        dotnet clean AssetTag/AssetTag.csproj --configuration Release
        
        # Build with more verbosity
        dotnet build AssetTag/AssetTag.csproj --configuration Release --verbosity normal
        
        # Create appsettings.Production.json first to include in publish
        echo 'Creating production appsettings...'
        cat > ./AssetTag/appsettings.Production.json << 'EOF'
{
  "ConnectionStrings": {
    "DefaultConnection": "$ConnectionStrings__DefaultConnection"
  },
  "Jwt": {
    "Key": "$JWT_SECURITY_KEY",
    "Issuer": "AssetTagAPI",
    "Audience": "AssetTagUsers",
    "ExpireDays": 7
  },
  "EmailSettings": {
    "Username": "$EMAIL_USERNAME",
    "Password": "$EMAIL_PASSWORD",
    "SmtpServer": "smtp.gmail.com",
    "SmtpPort": 587,
    "EnableSsl": true,
    "FromEmail": "$EMAIL_USERNAME"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    },
    "File": {
      "Path": "logs/assetapi-.log",
      "Append": true,
      "FileSizeLimitBytes": 10485760,
      "MaxRollingFiles": 5
    }
  },
  "AllowedHosts": "*",
  "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://0.0.0.0:5000"
      }
    }
  }
}
EOF
        
        # Publish with all required runtime components
        dotnet publish AssetTag/AssetTag.csproj \
          --configuration Release \
          --output ./publish/api \
          --no-restore \
          --self-contained false \
          --runtime linux-x64 \
          -p:EnvironmentName=Production \
          -p:DebugType=None \
          -p:DebugSymbols=false
        
        echo 'Publish completed. Files in publish/api/:'
        ls -la ./publish/api/
        echo ''
        echo 'Important files check:'
        [ -f "./publish/api/AssetTag.dll" ] && echo "✅ AssetTag.dll exists" || echo "❌ AssetTag.dll missing"
        [ -f "./publish/api/appsettings.json" ] && echo "✅ appsettings.json exists" || echo "❌ appsettings.json missing"
        [ -f "./publish/api/appsettings.Production.json" ] && echo "✅ appsettings.Production.json exists" || echo "❌ appsettings.Production.json missing"
    
    - name: Build and Publish Portal (if changed)
      if: needs.detect-changes.outputs.portal-changed == 'true'
      run: |
        dotnet publish Portal/Portal.csproj \
          --configuration Release \
          --output ./publish/portal \
          --self-contained false \
          --runtime linux-x64 \
          -p:UseAppHost=false
        
        echo '{
          "ApiSettings": {
            "BaseUrl": "http://mugassetapi.runasp.net/"
          },
          "Logging": {
            "LogLevel": {
              "Default": "Information",
              "Microsoft.AspNetCore": "Warning"
            }
          }
        }' > ./publish/portal/appsettings.Production.json
    
    - name: Upload API artifact
      if: needs.detect-changes.outputs.api-changed == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: api-deployment
        path: ./publish/api/
        retention-days: 7
    
    - name: Upload Portal artifact
      if: needs.detect-changes.outputs.portal-changed == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: portal-deployment
        path: ./publish/portal/
        retention-days: 7

  run-migrations:
    needs: 
      - detect-changes
      - build-and-publish
    if: needs.detect-changes.outputs.api-changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore for EF Tool
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    
    - name: Install EF Tool
      run: |
        dotnet tool update --global dotnet-ef
        dotnet ef --version
    
    - name: Create EF appsettings for migrations
      env:
        ConnectionStrings__DefaultConnection: ${{ secrets.MONSTERASP_DATABASE_CONNECTION }}
      run: |
        mkdir -p ./AssetTag/bin/Release/net9.0/
        echo "{
          \"ConnectionStrings\": {
            \"DefaultConnection\": \"$ConnectionStrings__DefaultConnection\"
          }
        }" > ./AssetTag/bin/Release/net9.0/appsettings.Production.json
    
    - name: Run Database Migrations
      env:
        ConnectionStrings__DefaultConnection: ${{ secrets.MONSTERASP_DATABASE_CONNECTION }}
      run: |
        echo "Running migrations with connection string..."
        cd AssetTag
        dotnet ef database update \
          --configuration Release \
          --verbose
        echo "✅ Database migrations completed"

  deploy-api:
    needs: 
      - detect-changes
      - build-and-publish
      - run-migrations
    if: needs.detect-changes.outputs.api-changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Create deployment directory
      run: mkdir -p ./api-deployment
    
    - name: Download API artifact
      uses: actions/download-artifact@v4
      with:
        name: api-deployment
        path: ./api-deployment/
    
    - name: Verify deployment files
      run: |
        echo "=== Deployment File Structure ==="
        find ./api-deployment -type f -name "*.dll" | head -20
        echo ""
        echo "=== Total files: $(find ./api-deployment -type f | wc -l) ==="
        echo ""
        echo "=== Key files check ==="
        ls -la ./api-deployment/ | grep -E "(dll|json|exe|so|dylib)"
        echo ""
        echo "=== appsettings check ==="
        ls -la ./api-deployment/*.json
        echo ""
        echo "=== Web.config check ==="
        [ -f "./api-deployment/web.config" ] && cat ./api-deployment/web.config || echo "No web.config found"
    
    - name: Create web.config for API (if missing)
      run: |
        if [ ! -f "./api-deployment/web.config" ]; then
          echo 'Creating web.config for API...'
          cat > ./api-deployment/web.config << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <handlers>
        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>
      <aspNetCore processPath="dotnet" 
                  arguments=".\AssetTag.dll" 
                  stdoutLogEnabled="true" 
                  stdoutLogFile=".\logs\stdout" 
                  hostingModel="inprocess">
        <environmentVariables>
          <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
          <environmentVariable name="DOTNET_CLI_TELEMETRY_OPTOUT" value="1" />
        </environmentVariables>
      </aspNetCore>
      <httpErrors errorMode="Detailed" />
    </system.webServer>
  </location>
</configuration>
EOF
          echo "✅ web.config created"
        else
          echo "✅ web.config already exists"
        fi
    
    - name: Create logs directory
      run: |
        mkdir -p ./api-deployment/logs
        echo "Logs directory created" > ./api-deployment/logs/README.txt
    
    - name: Create app_offline.htm for API
      run: |
        cat > ./app_offline_api.htm << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>API Maintenance</title>
    <meta http-equiv="refresh" content="30">
</head>
<body>
    <h1>API is updating...</h1>
    <p>Please wait. The API will be back online shortly.</p>
</body>
</html>
EOF
    
    - name: Upload app_offline.htm to take API offline
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.MONSTERASP_FTP_SERVER_API }}
        username: ${{ secrets.MONSTERASP_FTP_USERNAME_API }}
        password: ${{ secrets.MONSTERASP_FTP_PASSWORD_API }}
        local-dir: ./
        server-dir: /wwwroot/
        exclude: |
          **/*
        include: |
          app_offline_api.htm
        log-level: verbose
    
    - name: Wait for API to gracefully shutdown
      run: sleep 20
    
    - name: Deploy API to MonsterASP via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.MONSTERASP_FTP_SERVER_API }}
        username: ${{ secrets.MONSTERASP_FTP_USERNAME_API }}
        password: ${{ secrets.MONSTERASP_FTP_PASSWORD_API }}
        local-dir: ./api-deployment/
        server-dir: /wwwroot/
        exclude: |
          **/.git*
          **/.git*/
          **/appsettings.Development.json
          **/*.pdb
        log-level: verbose
      timeout-minutes: 5
    
    - name: Remove app_offline.htm to bring API online
      run: |
        echo "Removing app_offline.htm..."
        # Create empty file to trigger delete
        echo "" > ./empty_file
        # We'll let the FTP action delete the file by not including it
    
    - name: Delete app_offline.htm via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.MONSTERASP_FTP_SERVER_API }}
        username: ${{ secrets.MONSTERASP_FTP_USERNAME_API }}
        password: ${{ secrets.MONSTERASP_FTP_PASSWORD_API }}
        local-dir: ./empty_deploy/
        server-dir: /wwwroot/
        exclude: |
          **/*
        log-level: verbose
        dangerous-clean-slate: false
    
    - name: Verify API deployment and startup
      run: |
        echo "✅ Deployment completed. Waiting for API to start..."
        sleep 30
        echo "Testing API endpoint..."
        
        # Try to call the API
        API_URL="http://mugassetapi.runasp.net"
        
        for i in {1..10}; do
          echo "Attempt $i to reach API..."
          if curl -f -s -o /dev/null -w "%{http_code}" --max-time 10 "$API_URL" > /dev/null 2>&1; then
            echo "✅ API is responding!"
            curl -s "$API_URL" | head -c 500
            echo ""
            exit 0
          else
            echo "⏳ API not responding yet, waiting 5 seconds..."
            sleep 5
          fi
        done
        
        echo "❌ API did not start properly within 50 seconds"
        echo "Please check:"
        echo "1. MonsterASP control panel for error logs"
        echo "2. Ensure .NET 9.0 runtime is installed on server"
        echo "3. Check database connection string"
        exit 1

  deploy-portal:
    needs: 
      - detect-changes
      - build-and-publish
    if: needs.detect-changes.outputs.portal-changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Create deployment directory
      run: mkdir -p ./portal-deployment
    
    - name: Download Portal artifact
      uses: actions/download-artifact@v4
      with:
        name: portal-deployment
        path: ./portal-deployment/
    
    - name: Verify files exist before deployment
      run: |
        echo "Checking deployment files..."
        if [ ! -d "./portal-deployment" ]; then
          echo "❌ ERROR: Deployment directory not found"
          exit 1
        fi
        
        if [ -z "$(ls -A ./portal-deployment)" ]; then
          echo "❌ ERROR: Deployment directory is empty"
          exit 1
        fi
        echo "✅ Ready to deploy $(find ./portal-deployment -type f | wc -l) files"
    
    - name: Create app_offline.htm for Portal
      run: |
        echo '<!DOCTYPE html>
        <html>
        <head>
            <title>Portal Under Maintenance</title>
            <meta http-equiv="refresh" content="30">
        </head>
        <body>
            <h1>Portal is updating...</h1>
            <p>Please wait. The portal will be back online shortly.</p>
        </body>
        </html>' > ./app_offline_portal.htm
    
    - name: Upload app_offline.htm to take Portal offline
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.MONSTERASP_FTP_SERVER_PORTAL }}
        username: ${{ secrets.MONSTERASP_FTP_USERNAME_PORTAL }}
        password: ${{ secrets.MONSTERASP_FTP_PASSWORD_PORTAL }}
        local-dir: ./
        server-dir: /wwwroot/
        exclude: |
          **/*
        include: |
          app_offline_portal.htm
        log-level: verbose
    
    - name: Wait for Portal to gracefully shutdown (10 seconds)
      run: sleep 10
    
    - name: Deploy Portal to MonsterASP via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.MONSTERASP_FTP_SERVER_PORTAL }}
        username: ${{ secrets.MONSTERASP_FTP_USERNAME_PORTAL }}
        password: ${{ secrets.MONSTERASP_FTP_PASSWORD_PORTAL }}
        local-dir: ./portal-deployment/
        server-dir: /wwwroot/
        exclude: |
          **/.git*
          **/.git*/
          **/appsettings.Development.json
          app_offline_portal.htm
        log-level: verbose
    
    - name: Remove app_offline.htm to bring Portal online
      run: |
        mkdir -p ./empty-deploy-portal
        echo '' > ./empty-deploy-portal/.keep
    
    - name: Delete app_offline.htm via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.MONSTERASP_FTP_SERVER_PORTAL }}
        username: ${{ secrets.MONSTERASP_FTP_USERNAME_PORTAL }}
        password: ${{ secrets.MONSTERASP_FTP_PASSWORD_PORTAL }}
        local-dir: ./empty-deploy-portal/
        server-dir: /wwwroot/
        exclude: |
          **/*
        dangerous-clean-slate: false
        log-level: verbose
      env:
        FTP_DELETE_EXTRA: true
    
    - name: Verify Portal deployment
      run: |
        echo "✅ Portal deployment completed"
        echo "Waiting 5 seconds for Portal to start up..."
        sleep 5
        echo "Portal should now be online and serving requests"
